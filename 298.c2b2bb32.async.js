"use strict";(self.webpackChunkWebAVPro_Doc_Site=self.webpackChunkWebAVPro_Doc_Site||[]).push([[298],{92056:function(t,e,n){n.r(e),n.d(e,{AVCanvas:function(){return Dn},AVCliper:function(){return r},AVProRegister:function(){return Un}});var r={};n.r(r),n.d(r,{AudioClip:function(){return st},Combinator:function(){return Pt},EmbedSubtitlesClip:function(){return lt},ImgClip:function(){return ot},Log:function(){return m},MP4Clip:function(){return J},MediaStreamClip:function(){return ct},OffscreenSprite:function(){return Rt},Rect:function(){return Ct},VisibleSprite:function(){return It},createChromakey:function(){return St},fastConcatMP4:function(){return ht},fixFMP4Duration:function(){return pt},mixinMP4AndAudio:function(){return yt},renderTxt2ImgBitmap:function(){return B}});var i=n(29008),a=n.n(i),o=n(70958),s=n.n(o),c=n(34981);class l{static forwardEvent(t,e,n){const r=n.map((n=>{const[r,i]=Array.isArray(n)?n:[n,n];return t.on(r,((...t)=>{e.emit(i,...t)}))}));return()=>{r.forEach((t=>t()))}}#t=new Map;on=(t,e)=>{const n=this.#t.get(t)??new Set;return n.add(e),this.#t.has(t)||this.#t.set(t,n),()=>{n.delete(e),0===n.size&&this.#t.delete(t)}};once=(t,e)=>{const n=this.on(t,((...t)=>{n(),e(...t)}));return n};emit=(t,...e)=>{this.#t.get(t)?.forEach((t=>t(...e)))};destroy(){this.#t.clear()}}function d(){const t=new Date;return`${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}.${t.getMilliseconds()}`}let u=1;const h=[],p=["debug","info","warn","error"].reduce(((t,e,n)=>Object.assign(t,{[e]:(...t)=>{u<=n&&(console[e](...t),h.push({lvName:e,timeStr:d(),args:t}))}})),{}),f=new Map,m={setLogLevel:t=>{u=f.get(t)??1},...p,create:t=>Object.fromEntries(Object.entries(p).map((([e,n])=>[e,(...e)=>n(t,...e)]))),async dump(){return h.reduce(((t,{lvName:e,timeStr:n,args:r})=>t+`[${e}][${n}]  ${r.map((t=>function(t){return t instanceof Error?String(t):"object"==typeof t?JSON.stringify(t,((t,e)=>e instanceof Error?String(e):e)):String(t)}(t))).join(" ")}\n`),"")}};f.set(m.debug,0),f.set(m.info,1),f.set(m.warn,2),f.set(m.error,3),async function(){if(await Promise.resolve(),null!=globalThis.navigator&&null!=globalThis.document&&(m.info(`@webav version: 1.1.17, date: ${(new Date).toLocaleDateString()}`),m.info(globalThis.navigator.userAgent),document.addEventListener("visibilitychange",(()=>{m.info(`visibilitychange: ${document.visibilityState}`)})),"PressureObserver"in globalThis)){let t="";new PressureObserver((e=>{const n=JSON.stringify(e.map((t=>t.state)));n!==t&&(m.info(`cpu state change: ${n}`),t=n)})).observe("cpu")}}();const y=(t,e)=>{const n=new Uint8Array(8);new DataView(n.buffer).setUint32(0,e);for(let e=0;e<4;e++)n[4+e]=t.charCodeAt(e);return n},g=t=>{const e=(()=>{const t=new TextEncoder,e=t.encode("mdta"),n=t.encode("mp4 handler"),r=32+n.byteLength+1,i=new Uint8Array(r),a=new DataView(i.buffer);return i.set(y("hdlr",r),0),a.setUint32(8,0),i.set(e,16),i.set(n,32),i})(),n=(t=>{const e=new TextEncoder,n=e.encode("mdta"),r=t.map((t=>{const r=e.encode(t),i=8+r.byteLength,a=new Uint8Array(i);return new DataView(a.buffer).setUint32(0,i),a.set(n,4),a.set(r,4+n.byteLength),a})),i=16+r.reduce(((t,e)=>t+e.byteLength),0),a=new Uint8Array(i),o=new DataView(a.buffer);a.set(y("keys",i),0),o.setUint32(8,0),o.setUint32(12,t.length);let s=16;for(const t of r)a.set(t,s),s+=t.byteLength;return a})(Object.keys(t)),r=(t=>{const e=new TextEncoder,n=e.encode("data"),r=Object.entries(t).map((([t,r],i)=>{const a=i+1,o=e.encode(r),s=24+o.byteLength,c=new Uint8Array(s),l=new DataView(c.buffer);return l.setUint32(0,s),l.setUint32(4,a),l.setUint32(8,16+o.byteLength),c.set(n,12),l.setUint32(16,1),c.set(o,24),c})),i=8+r.reduce(((t,e)=>t+e.byteLength),0),a=new Uint8Array(i);a.set(y("ilst",i),0);let o=8;for(const t of r)a.set(t,o),o+=t.byteLength;return a})(t),i=e.length+n.length+r.length,a=new Uint8Array(i);return a.set(e,0),a.set(n,e.length),a.set(r,e.length+n.length),a},w=()=>{let t;self.onmessage=e=>{"start"===e.data.event&&(self.clearInterval(t),t=self.setInterval((()=>{self.postMessage({})}),16.6)),"stop"===e.data.event&&self.clearInterval(t)}},x=new Map;let v=1,b=null;null!=globalThis.Worker&&(b=(()=>{const t=new Blob([`(${w.toString()})()`]),e=URL.createObjectURL(t);return new Worker(e)})(),b.onmessage=()=>{v+=1;for(const[t,e]of x)if(v%t==0)for(const t of e)t()});const S=(t,e)=>{const n=Math.round(e/16.6),r=x.get(n)??new Set;return r.add(t),x.set(n,r),1===x.size&&1===r.size&&b?.postMessage({event:"start"}),()=>{r.delete(t),0===r.size&&x.delete(n),0===x.size&&(v=0,b?.postMessage({event:"stop"}))}};function C(t){m.info("recodemux opts:",t);const e=c.createFile(),n=new l;let r=!1;const i=()=>{null==e.moov||r||(r=!0,null!=t.metaDataTags&&((t,e)=>{const n=t.add("udta").add("meta");n.data=g(e),n.size=n.data.byteLength})(e.moov,t.metaDataTags),null!=t.duration&&(e.moov.mvhd.duration=t.duration))};n.once("VideoReady",i),n.once("AudioReady",i);let a=null!=t.video?function(t,e,n){const r={timescale:1e6,width:t.width,height:t.height,brands:["isom","iso2","avc1","mp42","mp41"],avcDecoderConfigRecord:null,hevcDecoderConfigRecord:null,vpcDecoderConfigRecord:null,type:"avc1",name:"Track created with WebAV"};let i=-1,a=!1;n.once("AudioReady",(()=>{a=!0}));const o={encoder0:[],encoder1:[]},s=(a,s,c)=>{if(-1===i&&null!=c){let a=c.decoderConfig?.description;t.codec.startsWith("avc1")?function(t){const e=new Uint8Array(t);e[2].toString(2).slice(-2).includes("1")&&(e[2]=0)}(a):t.codec.startsWith("vp09")&&c.decoderConfig&&(r.type="vp09",a=function(t){const e=t.codec.split("."),n=parseInt(e[1]||"0",10),r=parseInt(e[2]||"40",10),i=parseInt(e[3]||"08",10),a={bt709:1,bt601:5,bt2020:9},o={bt709:1,srgb:13,pq:16,hlg:18},s={bt709:1,bt601:5,bt2020:9},c=a[t.colorSpace?.primaries||"bt709"]||1,l=o[t.colorSpace?.transfer||"bt709"]||1,d=s[t.colorSpace?.matrix||"bt709"]||1,u=t.colorSpace?.fullRange?1:0,h=1,p=0,f=new ArrayBuffer(12),m=new DataView(f);let y=0;return m.setUint32(y,1<<24),y+=4,m.setUint8(y++,n),m.setUint8(y++,r),m.setUint8(y++,i<<4|h<<1|u),m.setUint8(y++,c),m.setUint8(y++,l),m.setUint8(y++,d),m.setUint16(y,p),f}(c.decoderConfig));const o=[["avc1","avcDecoderConfigRecord"],["hvc1","hevcDecoderConfigRecord"],["vp09","vpcDecoderConfigRecord"]].find((([e])=>t.codec.startsWith(e)))?.[1];null!=o&&null!=a&&(r[o]=a),i=e.addTrack(r),n.emit("VideoReady"),m.info("VideoEncoder, video track ready, trackId:",i)}o[a].push(A(s))};let c="encoder1",l=0;const d=Math.floor(1e3/t.expectFPS*1e3);function u(){if(!a)return;const t="encoder1"===c?"encoder0":"encoder1",e=o[c],n=o[t];if(0===e.length&&0===n.length)return;let r=e[0];if(null!=r&&(!r.is_sync||r.cts-l<d)){const t=h(e);t>l&&(l=t)}const i=n[0];if(i?.is_sync&&i.cts-l<d)return c=t,void u();if(r?.is_sync&&i?.is_sync){if(!(r.cts<=i.cts))return c=t,void u();{const t=h(e);t>l&&(l=t)}}}function h(t){let n=-1,r=0;for(;r<t.length;r++){const a=t[r];if(r>0&&a.is_sync)break;e.addSample(i,a.data,a),n=a.cts+a.duration}return t.splice(0,r),n}const p=S(u,15),f=k(t,((t,e)=>s("encoder0",t,e))),y=k(t,((t,e)=>s("encoder1",t,e)));let g=0;return{get encodeQueueSize(){return f.encodeQueueSize+y.encodeQueueSize},encode:(t,e)=>{try{e.keyFrame&&(g+=1),(g%2==0?f:y).encode(t,e)}catch(n){const r=`encode video frame error: ${n.message}, state: ${JSON.stringify({ts:t.timestamp,keyFrame:e.keyFrame,duration:t.duration,gopId:g})}`;throw m.error(r),Error(r)}},flush:async()=>{await Promise.all(["configured"===f.state?await f.flush():null,"configured"===y.state?await y.flush():null]),p(),u()},close:()=>{"configured"===f.state&&f.close(),"configured"===y.state&&y.close()}}}(t.video,e,n):null,o=null!=t.audio?function(t,e,n){const r={timescale:1e6,samplerate:t.sampleRate,channel_count:t.channelCount,hdlr:"soun",type:"aac"===t.codec?"mp4a":"Opus",name:"Track created with WebAV"};let i=-1,a=[],o=!1;n.once("VideoReady",(()=>{o=!0,a.forEach((t=>{const n=A(t);e.addSample(i,n.data,n)})),a=[]}));const s={codec:"aac"===t.codec?"mp4a.40.2":"opus",sampleRate:t.sampleRate,numberOfChannels:t.channelCount,bitrate:128e3},c=new AudioEncoder({error:t=>{const e=`AudioEncoder error: ${t.message}, config: ${JSON.stringify(s)}, state: ${JSON.stringify({qSize:c.encodeQueueSize,state:c.state})}`;throw m.error(e),Error(e)},output:(t,s)=>{if(-1===i){const t=s?.decoderConfig?.description;i=e.addTrack({...r,description:null==t?void 0:T(t)}),n.emit("AudioReady"),m.info("AudioEncoder, audio track ready, trackId:",i)}if(o){const n=A(t);e.addSample(i,n.data,n)}else a.push(t)}});return c.configure(s),c}(t.audio,e,n):null;return null==t.video&&n.emit("VideoReady"),null==t.audio&&n.emit("AudioReady"),{encodeVideo:(t,e)=>{a?.encode(t,e),t.close()},encodeAudio:t=>{if(null!=o)try{o.encode(t),t.close()}catch(t){const e=`encode audio chunk error: ${t.message}, state: ${JSON.stringify({qSize:o.encodeQueueSize,state:o.state})}`;throw m.error(e),Error(e)}},getEncodeQueueSize:()=>a?.encodeQueueSize??o?.encodeQueueSize??0,flush:async()=>{await Promise.all([a?.flush(),"configured"===o?.state?o.flush():null])},close:()=>{n.destroy(),a?.close(),"configured"===o?.state&&o.close()},mp4file:e}}function k(t,e){const n={codec:t.codec,framerate:t.expectFPS,hardwareAcceleration:t.__unsafe_hardwareAcceleration__,bitrate:t.bitrate,width:t.width,height:t.height,alpha:"discard",avc:{format:"avc"}},r=new VideoEncoder({error:t=>{const e=`VideoEncoder error: ${t.message}, config: ${JSON.stringify(n)}, state: ${JSON.stringify({qSize:r.encodeQueueSize,state:r.state})}`;throw m.error(e),Error(e)},output:e});return r.configure(n),r}function T(t){const e=t.byteLength,n=new Uint8Array([0,0,0,0,3,23+e,0,2,0,4,18+e,64,21,0,0,0,0,0,0,0,0,0,0,0,5,e,...new Uint8Array(t instanceof ArrayBuffer?t:t.buffer),6,1,2]),r=new c.BoxParser.esdsBox(n.byteLength);return r.hdr_size=0,r.parse(new c.DataStream(n,0,c.DataStream.BIG_ENDIAN)),r}function A(t){const e=new ArrayBuffer(t.byteLength);t.copyTo(e);const n=t.timestamp;return{duration:t.duration??0,dts:n,cts:n,is_sync:"key"===t.type,data:e}}function E(t,e){let n=!1;return async function(){const r=t.getReader();for(;!n;){const{value:t,done:n}=await r.read();if(n)return void e.onDone();await e.onChunk(t)}r.releaseLock(),await t.cancel()}().catch(console.error),()=>{n=!0}}function F(t,e,n){let r=0,i=0;const a=t.boxes;let o=!1;const s=()=>{if(!o){if(null==a.find((t=>"moof"===t.type)))return null;o=!0}if(i>=a.length)return null;const e=new c.DataStream;e.endianness=c.DataStream.BIG_ENDIAN;let n=i;try{for(;n<a.length;)a[n].write(e),delete a[n],n+=1}catch(t){const e=a[n];throw t instanceof Error&&null!=e?Error(`${t.message} | deltaBuf( boxType: ${e.type}, boxSize: ${e.size}, boxDataLen: ${e.data?.length??-1})`):t}return function(t){if(null!=t.moov){for(var e=0;e<t.moov.traks.length;e++)t.moov.traks[e].samples=[];t.mdats=[],t.moofs=[]}}(t),i=a.length,new Uint8Array(e.buffer)};let l=!1,d=!1,u=null;return{stream:new ReadableStream({start(n){r=self.setInterval((()=>{const t=s();null!=t&&!d&&n.enqueue(t)}),e),u=e=>{if(clearInterval(r),t.flush(),null!=e)return void n.error(e);const i=s();null!=i&&!d&&n.enqueue(i),d||n.close()},l&&u()},cancel(){d=!0,clearInterval(r),n?.()}}),stop:t=>{l||(l=!0,u?.(t))}}}function R(t,e){let n;return function(...r){if(null==n||performance.now()-n>e)return n=performance.now(),t.apply(this,r)}}var I=n(65857),M=n(71843),O=n(21521);async function P(t,e,n={}){const r=function(t){return document.createElement(t)}("pre");r.style.cssText=`margin: 0; ${e}; position: fixed;`,r.textContent=t,document.body.appendChild(r),n.onCreated?.(r);const{width:i,height:a}=r.getBoundingClientRect();r.remove();const o=new Image;o.width=i,o.height=a;const s=null==n.font?"":`\n    @font-face {\n      font-family: '${n.font.name}';\n      src: url('data:font/woff2;base64,${function(t){var e="",n=new Uint8Array(t),r=n.byteLength;for(let t=0;t<r;t++)e+=String.fromCharCode(n[t]);return window.btoa(e)}(await(await fetch(n.font.url)).arrayBuffer())}') format('woff2');\n    }\n  `,c=`\n    <svg xmlns="http://www.w3.org/2000/svg" width="${i}" height="${a}">\n      <style>\n        ${s}\n      </style>\n      <foreignObject width="100%" height="100%">\n        <div xmlns="http://www.w3.org/1999/xhtml">${r.outerHTML}</div>\n      </foreignObject>\n    </svg>\n  `.replace(/\t/g,"").replace(/#/g,"%23");return o.src=`data:image/svg+xml;charset=utf-8,${c}`,await new Promise((t=>{o.onload=t})),o}async function B(t,e,n={}){const r=await P(t,e,n),i=new OffscreenCanvas(r.width,r.height);return i.getContext("2d")?.drawImage(r,0,0,r.width,r.height),await createImageBitmap(i)}function L(t){const e=new Float32Array(t.map((t=>t.length)).reduce(((t,e)=>t+e)));let n=0;for(const r of t)e.set(r,n),n+=r.length;return e}function _(t){if("f32-planar"===t.format){const e=[];for(let n=0;n<t.numberOfChannels;n+=1){const r=t.allocationSize({planeIndex:n}),i=new ArrayBuffer(r);t.copyTo(i,{planeIndex:n}),e.push(new Float32Array(i))}return e}if("f32"===t.format){const e=new ArrayBuffer(t.allocationSize({planeIndex:0}));return t.copyTo(e,{planeIndex:0}),function(t,e){const n=t.length/e,r=Array.from({length:e},(()=>new Float32Array(n)));for(let i=0;i<n;i++)for(let n=0;n<e;n++)r[n][i]=t[i*e+n];return r}(new Float32Array(e),t.numberOfChannels)}if("s16"===t.format){const e=new ArrayBuffer(t.allocationSize({planeIndex:0}));return t.copyTo(e,{planeIndex:0}),function(t,e){const n=t.length/e,r=Array.from({length:e},(()=>new Float32Array(n)));for(let i=0;i<n;i++)for(let n=0;n<e;n++){const a=t[i*e+n];r[n][i]=a/32768}return r}(new Int16Array(e),t.numberOfChannels)}throw Error("Unsupported audio data format")}function W(t){return Array(t.numberOfChannels).fill(0).map(((e,n)=>t.getChannelData(n)))}function V(t){const e=Math.max(...t.map((t=>t[0]?.length??0))),n=new Float32Array(2*e);for(let r=0;r<e;r++){let i=0,a=0;for(let e=0;e<t.length;e++){const n=t[e][0]?.[r]??0;i+=n,a+=t[e][1]?.[r]??n}n[r]=i,n[r+e]=a}return n}function z(t){return new Promise((e=>{const n=S((()=>{n(),e()}),t)}))}function D(t,e,n){const r=n-e,i=new Float32Array(r);let a=0;for(;a<r;)i[a]=t[(e+a)%t.length],a+=1;return i}function U(t,e){const n=Math.floor(t.length/e),r=new Float32Array(n);for(let i=0;i<n;i++){const n=i*e,a=Math.floor(n),o=n-a;a+1<t.length?r[i]=t[a]*(1-o)+t[a+1]*o:r[i]=t[a]}return r}const N=48e3,$=2,j="mp4a.40.2";function H(t,e){const n=e.videoTracks[0],r={};if(null!=n){const i=function(t){for(const e of t.mdia.minf.stbl.stsd.entries){const t=e.avcC??e.hvcC??e.av1C??e.vpcC;if(null!=t){const e=new c.DataStream(void 0,0,c.DataStream.BIG_ENDIAN);return t.write(e),new Uint8Array(e.buffer.slice(8))}}}(t.getTrackById(n.id))?.buffer,{descKey:a,type:o}=n.codec.startsWith("avc1")?{descKey:"avcDecoderConfigRecord",type:"avc1"}:n.codec.startsWith("hvc1")?{descKey:"hevcDecoderConfigRecord",type:"hvc1"}:{descKey:"",type:""};""!==a&&(r.videoTrackConf={timescale:n.timescale,duration:n.duration,width:n.video.width,height:n.video.height,brands:e.brands,type:o,[a]:i}),r.videoDecoderConf={codec:n.codec,codedHeight:n.video.height,codedWidth:n.video.width,description:i}}const i=e.audioTracks[0];if(null!=i){const e=Y(t);r.audioTrackConf={timescale:i.timescale,samplerate:i.audio.sample_rate,channel_count:i.audio.channel_count,hdlr:"soun",type:i.codec.startsWith("mp4a")?"mp4a":i.codec,description:Y(t)},r.audioDecoderConf={codec:i.codec.startsWith("mp4a")?j:i.codec,numberOfChannels:i.audio.channel_count,sampleRate:i.audio.sample_rate,...null==e?{}:G(e)}}return r}function Y(t,e="mp4a"){return t.moov?.traks.map((t=>t.mdia.minf.stbl.stsd.entries)).flat().find((({type:t})=>t===e))?.esds}function G(t){const e=t.esd.descs[0]?.descs[0];if(null==e)return{};const[n,r]=e.data;return{sampleRate:[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][((7&n)<<1)+(r>>7)],numberOfChannels:(127&r)>>3}}let X=0;function Q(t){return"file"===t.kind&&t.createReader instanceof Function}class J{#e=X++;#n=m.create(`MP4Clip id:${this.#e},`);ready;#t=!1;#r={duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0};get meta(){return{...this.#r}}#i;#a=[];async getFileHeaderBinData(){await this.ready;const t=await this.#i.getOriginFile();if(null==t)throw Error("MP4Clip localFile is not origin file");return await new Blob(this.#a.map((({start:e,size:n})=>t.slice(e,e+n)))).arrayBuffer()}#o=1;#s=[];#c=[];#l=null;#d=null;#u={video:null,audio:null};#h={audio:!0};constructor(t,e={}){if(!(t instanceof ReadableStream||Q(t)||Array.isArray(t.videoSamples)))throw Error("Illegal argument");this.#h={audio:!0,...e},this.#o="object"==typeof e.audio&&"volume"in e.audio?e.audio.volume:1;this.#i=Q(t)?t:"localFile"in t?t.localFile:(0,I.fm)(),this.ready=(t instanceof ReadableStream?(async t=>(await(0,I.cW)(this.#i,t),this.#i))(t).then((t=>K(t,this.#h))):Q(t)?K(t,this.#h):Promise.resolve(t)).then((async({videoSamples:t,audioSamples:e,decoderConf:n,headerBoxPos:r})=>{this.#s=t,this.#c=e,this.#u=n,this.#a=r;const{videoFrameFinder:i,audioFrameFinder:a}=function(t,e,n,r,i){return{audioFrameFinder:0===i||null==t.audio||0===r.length?null:new tt(e,r,t.audio,{volume:i,targetSampleRate:N}),videoFrameFinder:null==t.video||0===n.length?null:new Z(e,n,t.video)}}({video:null==n.video?null:{...n.video,hardwareAcceleration:this.#h.__unsafe_hardwareAcceleration__},audio:n.audio},await this.#i.createReader(),t,e,!1!==this.#h.audio?this.#o:0);return this.#l=i,this.#d=a,this.#r=function(t,e,n){const r={duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0};null!=t.video&&e.length>0&&(r.width=t.video.codedWidth??0,r.height=t.video.codedHeight??0),null!=t.audio&&n.length>0&&(r.audioSampleRate=N,r.audioChanCount=$);let i=0,a=0;if(e.length>0)for(let t=e.length-1;t>=0;t--){const n=e[t];if(!n.deleted){i=n.cts+n.duration;break}}if(n.length>0){const t=n.at(-1);a=t.cts+t.duration}return r.duration=Math.max(i,a),r}(n,t,e),this.#n.info("MP4Clip meta:",this.#r),{...this.#r}}))}tickInterceptor=async(t,e)=>e;async tick(t){if(t>=this.#r.duration)return await this.tickInterceptor(t,{audio:await(this.#d?.find(t))??[],state:"done"});const[e,n]=await Promise.all([this.#d?.find(t)??[],this.#l?.find(t)]);return null==n?await this.tickInterceptor(t,{audio:e,state:"success"}):await this.tickInterceptor(t,{video:n,audio:e,state:"success"})}#p=new AbortController;async thumbnails(t=100,e){this.#p.abort(),this.#p=new AbortController;const n=this.#p.signal;await this.ready;const r="generate thumbnails aborted";if(n.aborted)throw Error(r);const{width:i,height:a}=this.#r,o=function(t,e,n){const r=new OffscreenCanvas(t,e),i=r.getContext("2d");return async a=>(i.drawImage(a,0,0,t,e),a.close(),await r.convertToBlob(n))}(t,Math.round(a*(t/i)),{quality:.1,type:"image/png"});return new Promise((async(t,i)=>{let a=[];const s=this.#u.video;if(null==s||0===this.#s.length)return void c();async function c(){n.aborted||t(await Promise.all(a.map((async t=>({ts:t.ts,img:await t.img})))))}function l(t){a.push({ts:t.timestamp,img:o(t)})}n.addEventListener("abort",(()=>{i(Error(r))}));const{start:d=0,end:u=this.#r.duration,step:h}=e??{};if(h){let t=d;const e=new Z(await this.#i.createReader(),this.#s,{...s,hardwareAcceleration:this.#h.__unsafe_hardwareAcceleration__});for(;t<=u&&!n.aborted;){const n=await e.find(t);n&&l(n),t+=h}e.destroy(),c()}else await async function(t,e,n,r,i,a){const o=await e.createReader(),s=await nt(t.filter((t=>!t.deleted&&t.is_sync&&t.cts>=i.start&&t.cts<=i.end)),o);if(0===s.length||r.aborted)return void a(null,!0);let c=0;function l(t=!1){const e={...n,...t?{hardwareAcceleration:"prefer-software"}:{}},i=new VideoDecoder({output:t=>{c+=1;const e=c===s.length;a(t,e),e&&(o.close(),"closed"!==i.state&&i.close())},error:t=>{const n=`thumbnails decoder error: ${t.message}, config: ${JSON.stringify(e)}, state: ${JSON.stringify({qSize:i.decodeQueueSize,state:i.state,outputCnt:c,inputCnt:s.length})}`;throw m.error(n),Error(n)}});return r.addEventListener("abort",(()=>{o.close(),"closed"!==i.state&&i.close()})),i.configure(e),i}rt(l(),s,{onDecodingError:t=>{m.warn("thumbnailsByKeyFrame",t),0===c?rt(l(!0),s,{onDecodingError:t=>{o.close(),m.error("thumbnailsByKeyFrame retry soft deocde",t)}}):(a(null,!0),o.close())}})}(this.#s,this.#i,s,n,{start:d,end:u},((t,e)=>{null!=t&&l(t),e&&c()}))}))}async split(t){if(await this.ready,t<=0||t>=this.#r.duration)throw Error('"time" out of bounds');const[e,n]=function(t,e){if(0===t.length)return[];let n=0,r=0,i=-1;for(let a=0;a<t.length;a++){const o=t[a];if(-1===i&&e<o.cts&&(i=a-1),o.is_idr){if(-1!==i){r=a;break}n=a}}const a=t[i];if(null==a)throw Error("Not found video sample by time");const o=t.slice(0,0===r?t.length:r).map((t=>({...t})));for(let t=n;t<o.length;t++){const n=o[t];e<n.cts&&(n.deleted=!0,n.cts=-1)}it(o);const s=t.slice(a.is_idr?i:n).map((t=>({...t,cts:t.cts-e})));for(const t of s)t.cts<0&&(t.deleted=!0,t.cts=-1);return it(s),[o,s]}(this.#s,t),[r,i]=function(t,e){if(0===t.length)return[];let n=-1;for(let r=0;r<t.length;r++){const i=t[r];if(!(e>i.cts)){n=r;break}}if(-1===n)throw Error("Not found audio sample by time");const r=t.slice(0,n).map((t=>({...t}))),i=t.slice(n).map((t=>({...t,cts:t.cts-e})));return[r,i]}(this.#c,t),a=new J({localFile:this.#i,videoSamples:e??[],audioSamples:r??[],decoderConf:this.#u,headerBoxPos:this.#a},this.#h),o=new J({localFile:this.#i,videoSamples:n??[],audioSamples:i??[],decoderConf:this.#u,headerBoxPos:this.#a},this.#h);return await Promise.all([a.ready,o.ready]),[a,o]}async clone(){await this.ready;const t=new J({localFile:this.#i,videoSamples:[...this.#s],audioSamples:[...this.#c],decoderConf:this.#u,headerBoxPos:this.#a},this.#h);return await t.ready,t.tickInterceptor=this.tickInterceptor,t}async splitTrack(){await this.ready;const t=[];if(this.#s.length>0){const e=new J({localFile:this.#i,videoSamples:[...this.#s],audioSamples:[],decoderConf:{video:this.#u.video,audio:null},headerBoxPos:this.#a},this.#h);await e.ready,e.tickInterceptor=this.tickInterceptor,t.push(e)}if(this.#c.length>0){const e=new J({localFile:this.#i,videoSamples:[],audioSamples:[...this.#c],decoderConf:{audio:this.#u.audio,video:null},headerBoxPos:this.#a},this.#h);await e.ready,e.tickInterceptor=this.tickInterceptor,t.push(e)}return t}destroy(){this.#t||(this.#n.info("MP4Clip destroy"),this.#t=!0,this.#l?.destroy(),this.#d?.destroy())}}async function K(t,e={}){let n=null;const r={video:null,audio:null};let i=[],a=[],o=[],s=-1,l=-1;const d=await t.createReader();await async function(t,e,n){const r=c.createFile(!1);r.onReady=t=>{e({mp4boxFile:r,info:t});const n=t.videoTracks[0]?.id;null!=n&&r.setExtractionOptions(n,"video",{nbSamples:100});const i=t.audioTracks[0]?.id;null!=i&&r.setExtractionOptions(i,"audio",{nbSamples:100}),r.start()},r.onSamples=n,await async function(){let e=0;for(;;){const n=await t.read(31457280,{at:e});if(0===n.byteLength)break;n.fileStart=e;const i=r.appendBuffer(n);if(null==i)break;e=i}r.stop()}()}(d,(t=>{n=t.info;const e=t.mp4boxFile.ftyp;o.push({start:e.start,size:e.size});const i=t.mp4boxFile.moov;o.push({start:i.start,size:i.size});let{videoDecoderConf:a,audioDecoderConf:s}=H(t.mp4boxFile,t.info);r.video=a??null,r.audio=s??null,null==a&&null==s&&m.error("MP4Clip no video and audio track"),m.info("mp4BoxFile moov ready",{...t.info,tracks:null,videoTracks:null,audioTracks:null},r)}),((t,n,r)=>{if("video"===n){-1===s&&(s=r[0].dts);for(const t of r)i.push(q(t,s,"video"))}else if("audio"===n&&e.audio){-1===l&&(l=r[0].dts);for(const t of r)a.push(q(t,l,"audio"))}})),await d.close();const u=i.at(-1)??a.at(-1);if(null==n)throw Error("MP4Clip stream is done, but not emit ready");if(null==u)throw Error("MP4Clip stream not contain any sample");return it(i),m.info("mp4 stream parsed"),{videoSamples:i,audioSamples:a,decoderConf:r,headerBoxPos:o}}function q(t,e=0,n){let r=t.offset;const i="video"===n&&t.is_sync?function(t,e){if("avc1"!==e&&"hvc1"!==e)return 0;const n=new DataView(t.buffer);for(let r=0;r<t.byteLength-4;){if("avc1"===e){const t=31&n.getUint8(r+4);if(5===t||7===t||8===t)return r}else if("hvc1"===e){const t=n.getUint8(r+4)>>1&63;if(19===t||20===t||32===t||33===t||34===t)return r}r+=n.getUint32(r)+4}return-1}(t.data,t.description.type):-1;let a=t.size;return i>0&&(r+=i,a-=i),{...t,is_idr:i>=0,offset:r,size:a,cts:(t.cts-e)/t.timescale*1e6,dts:(t.dts-e)/t.timescale*1e6,duration:t.duration/t.timescale*1e6,timescale:1e6,data:"video"===n?null:t.data}}class Z{constructor(t,e,n){this.localFileReader=t,this.samples=e,this.conf=n}#e=null;#n=0;#t={abort:!1,st:performance.now()};find=async t=>{(null==this.#e||"closed"===this.#e.state||t<=this.#n||t-this.#n>3e6)&&this.#f(t),this.#t.abort=!0,this.#n=t,this.#t={abort:!1,st:performance.now()};const e=await this.#u(t,this.#e,this.#t);return this.#l=0,e};#r=0;#i=!1;#a=0;#o=[];#s=0;#c=0;#l=0;#d=!1;#u=async(t,e,n)=>{if(null==e||"closed"===e.state||n.abort)return null;if(this.#o.length>0){const r=this.#o[0];return t<r.timestamp?null:(this.#o.shift(),t>r.timestamp+(r.duration??0)?(r.close(),await this.#u(t,e,n)):(!this.#d&&this.#o.length<10&&this.#p(e).catch((e=>{throw this.#d=!0,this.#f(t),e})),r))}if(this.#h||this.#s<this.#c&&e.decodeQueueSize>0){if(performance.now()-n.st>6e3)throw Error(`MP4Clip.tick video timeout, ${JSON.stringify(this.#m())}`);this.#l+=1,await z(15)}else{if(this.#a>=this.samples.length)return null;try{await this.#p(e)}catch(e){throw this.#f(t),e}}return await this.#u(t,e,n)};#h=!1;#p=async t=>{if(this.#h||t.decodeQueueSize>600)return;let e=this.#a+1;if(e>this.samples.length)return;this.#h=!0;let n=!1;for(;e<this.samples.length;e++){const t=this.samples[e];if(!n&&!t.deleted&&(n=!0),t.is_idr)break}if(n){const n=this.samples.slice(this.#a,e);if(!0!==n[0]?.is_idr)m.warn("First sample not idr frame");else{const e=performance.now(),r=await nt(n,this.localFileReader),i=performance.now()-e;if(i>1e3){const t=n[0],e=n.at(-1),r=e.offset+e.size-t.offset;m.warn(`Read video samples time cost: ${Math.round(i)}ms, file chunk size: ${r}`)}if("closed"===t.state)return;this.#r=r[0]?.duration??0,rt(t,r,{onDecodingError:t=>{if(this.#i)throw t;0===this.#s&&(this.#i=!0,m.warn("Downgrade to software decode"),this.#f())}}),this.#c+=r.length}}this.#a=e,this.#h=!1};#f=t=>{if(this.#h=!1,this.#o.forEach((t=>t.close())),this.#o=[],null==t||0===t)this.#a=0;else{let e=0;for(let n=0;n<this.samples.length;n++){const r=this.samples[n];if(r.is_idr&&(e=n),!(r.cts<t)){this.#a=e;break}}}this.#c=0,this.#s=0,"closed"!==this.#e?.state&&this.#e?.close();const e={...this.conf,...this.#i?{hardwareAcceleration:"prefer-software"}:{}};this.#e=new VideoDecoder({output:t=>{if(this.#s+=1,-1===t.timestamp)return void t.close();let e=t;null==t.duration&&(e=new VideoFrame(t,{duration:this.#r}),t.close()),this.#o.push(e)},error:t=>{if(t.message.includes("Codec reclaimed due to inactivity"))return this.#e=null,void m.warn(t.message);const n=`VideoFinder VideoDecoder err: ${t.message}, config: ${JSON.stringify(e)}, state: ${JSON.stringify(this.#m())}`;throw m.error(n),Error(n)}}),this.#e.configure(e)};#m=()=>({time:this.#n,decState:this.#e?.state,decQSize:this.#e?.decodeQueueSize,decCusorIdx:this.#a,sampleLen:this.samples.length,inputCnt:this.#c,outputCnt:this.#s,cacheFrameLen:this.#o.length,softDeocde:this.#i,clipIdCnt:X,sleepCnt:this.#l,memInfo:at()});destroy=()=>{"closed"!==this.#e?.state&&this.#e?.close(),this.#e=null,this.#t.abort=!0,this.#o.forEach((t=>t.close())),this.#o=[],this.localFileReader.close()}}class tt{constructor(t,e,n,r){this.localFileReader=t,this.samples=e,this.conf=n,this.#e=r.volume,this.#n=r.targetSampleRate}#e=1;#n;#t=null;#r={abort:!1,st:performance.now()};find=async t=>{const e=t<=this.#i||t-this.#i>1e5;(null==this.#t||"closed"===this.#t.state||e)&&this.#d(),e&&(this.#i=t,this.#a=function(t,e){for(let n=0;n<e.length;n++){const r=e[n];if(t>=r.cts&&t<r.cts+r.duration)return n;if(r.cts>t)break}return 0}(t,this.samples)),this.#r.abort=!0;const n=t-this.#i;this.#i=t,this.#r={abort:!1,st:performance.now()};const r=await this.#c(Math.ceil(n*(this.#n/1e6)),this.#t,this.#r);return this.#s=0,r};#i=0;#a=0;#o={frameCnt:0,data:[]};#s=0;#c=async(t,e=null,n)=>{if(null==e||n.abort||"closed"===e.state||0===t)return[];const r=this.#o.frameCnt-t;if(r>0)return r<N/10&&this.#l(e),et(this.#o,t);if(e.decoding){if(performance.now()-n.st>3e3)throw n.abort=!0,Error(`MP4Clip.tick audio timeout, ${JSON.stringify(this.#u())}`);this.#s+=1,await z(15)}else{if(this.#a>=this.samples.length-1)return et(this.#o,this.#o.frameCnt);this.#l(e)}return this.#c(t,e,n)};#l=t=>{if(t.decodeQueueSize>10)return;const e=[];let n=this.#a;for(;n<this.samples.length;){const t=this.samples[n];if(n+=1,!t.deleted&&(e.push(t),e.length>=10))break}this.#a=n,t.decode(e.map((t=>new EncodedAudioChunk({type:"key",timestamp:t.cts,duration:t.duration,data:t.data}))))};#d=()=>{this.#i=0,this.#a=0,this.#o={frameCnt:0,data:[]},this.#t?.close(),this.#t=function(t,e,n){let r=0,i=0;const a=t=>{if(i+=1,0!==t.length){if(1!==e.volume)for(const n of t)for(let t=0;t<n.length;t++)n[t]*=e.volume;1===t.length&&(t=[t[0],t[0]]),n(t)}},o=function(t){const e=[];let n=0;function r(t,n){e[n]=t,i()}function i(){const r=e[n];null!=r&&(t(r),n+=1,i())}let a=0;return t=>{const e=a;a+=1,t().then((t=>r(t,e))).catch((t=>r(t,e)))}}(a),s=e.resampleRate!==t.sampleRate;let c=new AudioDecoder({output:t=>{const n=_(t);s?o((()=>async function(t,e,n){const r=t.length,i=Array(n.chanCount).fill(0).map((()=>new Float32Array(0)));if(0===r)return i;const a=Math.max(...t.map((t=>t.length)));if(0===a)return i;if(null==globalThis.OfflineAudioContext)return t.map((t=>new Float32Array(M.s(t,e,n.rate,{method:"sinc",LPF:!1}))));const o=new globalThis.OfflineAudioContext(n.chanCount,a*n.rate/e,n.rate),s=o.createBufferSource(),c=o.createBuffer(r,a,e);return t.forEach(((t,e)=>c.copyToChannel(t,e))),s.buffer=c,s.connect(o.destination),s.start(),W(await o.startRendering())}(n,t.sampleRate,{rate:e.resampleRate,chanCount:t.numberOfChannels}))):a(n),t.close()},error:t=>{t.message.includes("Codec reclaimed due to inactivity")||l("MP4Clip AudioDecoder err",t)}});function l(t,e){const n=`${t}: ${e.message}, state: ${JSON.stringify({qSize:c.decodeQueueSize,state:c.state,inputCnt:r,outputCnt:i})}`;throw m.error(n),Error(n)}return c.configure(t),{decode(t){r+=t.length;try{for(const e of t)c.decode(e)}catch(t){l("decode audio chunk error",t)}},close(){"closed"!==c.state&&c.close()},get decoding(){return r>i&&c.decodeQueueSize>0},get state(){return c.state},get decodeQueueSize(){return c.decodeQueueSize}}}(this.conf,{resampleRate:N,volume:this.#e},(t=>{this.#o.data.push(t),this.#o.frameCnt+=t[0].length}))};#u=()=>({time:this.#i,decState:this.#t?.state,decQSize:this.#t?.decodeQueueSize,decCusorIdx:this.#a,sampleLen:this.samples.length,pcmLen:this.#o.frameCnt,clipIdCnt:X,sleepCnt:this.#s,memInfo:at()});destroy=()=>{this.#t=null,this.#r.abort=!0,this.#o={frameCnt:0,data:[]},this.localFileReader.close()}}function et(t,e){const n=[new Float32Array(e),new Float32Array(e)];let r=0,i=0;for(;i<t.data.length;){const[a,o]=t.data[i];if(r+a.length>e){const s=e-r;n[0].set(a.subarray(0,s),r),n[1].set(o.subarray(0,s),r),t.data[i][0]=a.subarray(s,a.length),t.data[i][1]=o.subarray(s,o.length);break}n[0].set(a,r),n[1].set(o,r),r+=a.length,i++}return t.data=t.data.slice(i),t.frameCnt-=e,n}async function nt(t,e){const n=t[0],r=t.at(-1);if(null==r)return[];const i=r.offset+r.size-n.offset;if(i<3e7){const r=new Uint8Array(await e.read(i,{at:n.offset}));return t.map((t=>{const e=t.offset-n.offset;return new EncodedVideoChunk({type:t.is_sync?"key":"delta",timestamp:t.cts,duration:t.duration,data:r.subarray(e,e+t.size)})}))}return await Promise.all(t.map((async t=>new EncodedVideoChunk({type:t.is_sync?"key":"delta",timestamp:t.cts,duration:t.duration,data:await e.read(t.size,{at:t.offset})}))))}function rt(t,e,n){if("configured"===t.state){for(let n=0;n<e.length;n++)t.decode(e[n]);t.flush().catch((t=>{if(!(t instanceof Error))throw t;if(t.message.includes("Decoding error")&&null!=n.onDecodingError)n.onDecodingError(t);else if(!t.message.includes("Aborted due to close"))throw t}))}}function it(t){let e=0,n=null;for(const r of t)if(!r.deleted){if(r.is_sync&&(e+=1),e>=2)break;(null==n||r.cts<n.cts)&&(n=r)}null!=n&&n.cts<2e5&&(n.duration+=n.cts,n.cts=0)}function at(){try{const t=performance.memory;return{jsHeapSizeLimit:t.jsHeapSizeLimit,totalJSHeapSize:t.totalJSHeapSize,usedJSHeapSize:t.usedJSHeapSize,percentUsed:(t.usedJSHeapSize/t.jsHeapSizeLimit).toFixed(3),percentTotal:(t.totalJSHeapSize/t.jsHeapSizeLimit).toFixed(3)}}catch{return{}}}class ot{ready;#e={duration:0,width:0,height:0};get meta(){return{...this.#e}}#n=null;#t=[];constructor(t){const e=t=>(this.#n=t,this.#e.width=t.width,this.#e.height=t.height,this.#e.duration=1/0,{...this.#e});if(t instanceof ReadableStream)this.ready=new Response(t).blob().then((t=>createImageBitmap(t))).then(e);else if(t instanceof ImageBitmap)this.ready=Promise.resolve(e(t));else if(Array.isArray(t)&&t.every((t=>t instanceof VideoFrame))){this.#t=t;const e=this.#t[0];if(null==e)throw Error("The frame count must be greater than 0");this.#e={width:e.displayWidth,height:e.displayHeight,duration:this.#t.reduce(((t,e)=>t+(e.duration??0)),0)},this.ready=Promise.resolve({...this.#e,duration:1/0})}else{if(!("type"in t))throw Error("Illegal arguments");this.ready=this.#r(t.stream,t.type).then((()=>({width:this.#e.width,height:this.#e.height,duration:1/0})))}}async#r(t,e){this.#t=await async function(t,e){const n=new ImageDecoder({type:e,data:t});await Promise.all([n.completed,n.tracks.ready]);let r=n.tracks.selectedTrack?.frameCount??1;const i=[];for(let t=0;t<r;t+=1)i.push((await n.decode({frameIndex:t})).image);return i}(t,e);const n=this.#t[0];if(null==n)throw Error("No frame available in gif");this.#e={duration:this.#t.reduce(((t,e)=>t+(e.duration??0)),0),width:n.codedWidth,height:n.codedHeight},m.info("ImgClip ready:",this.#e)}tickInterceptor=async(t,e)=>e;async tick(t){if(null!=this.#n)return await this.tickInterceptor(t,{video:await createImageBitmap(this.#n),state:"success"});const e=t%this.#e.duration;return await this.tickInterceptor(t,{video:(this.#t.find((t=>e>=t.timestamp&&e<=t.timestamp+(t.duration??0)))??this.#t[0]).clone(),state:"success"})}async split(t){if(await this.ready,null!=this.#n)return[new ot(await createImageBitmap(this.#n)),new ot(await createImageBitmap(this.#n))];let e=-1;for(let n=0;n<this.#t.length;n++){const r=this.#t[n];if(!(t>r.timestamp)){e=n;break}}if(-1===e)throw Error("Not found frame by time");const n=this.#t.slice(0,e).map((t=>new VideoFrame(t))),r=this.#t.slice(e).map((e=>new VideoFrame(e,{timestamp:e.timestamp-t})));return[new ot(n),new ot(r)]}async clone(){await this.ready;const t=null==this.#n?this.#t.map((t=>t.clone())):await createImageBitmap(this.#n),e=new ot(t);return e.tickInterceptor=this.tickInterceptor,e}destroy(){m.info("ImgClip destroy"),this.#n?.close(),this.#t.forEach((t=>t.close()))}}class st{static ctx=null;ready;#e={duration:0,width:0,height:0};get meta(){return{...this.#e,sampleRate:N,chanCount:2}}#n=new Float32Array;#t=new Float32Array;getPCMData(){return[this.#n,this.#t]}#r;constructor(t,e={}){this.#r={loop:!1,volume:1,...e},this.ready=this.#i(t).then((()=>({width:0,height:0,duration:e.loop?1/0:this.#e.duration})))}async#i(t){null==st.ctx&&(st.ctx=new AudioContext({sampleRate:N}));const e=performance.now(),n=t instanceof ReadableStream?await async function(t,e){const n=await new Response(t).arrayBuffer();return W(await e.decodeAudioData(n))}(t,st.ctx):t;m.info("Audio clip decoded complete:",performance.now()-e);const r=this.#r.volume;if(1!==r)for(const t of n)for(let e=0;e<t.length;e+=1)t[e]*=r;this.#e.duration=n[0].length/N*1e6,this.#n=n[0],this.#t=n[1]??this.#n,m.info("Audio clip convert to AudioData, time:",performance.now()-e)}tickInterceptor=async(t,e)=>e;#a=0;#o=0;async tick(t){if(!this.#r.loop&&t>=this.#e.duration)return await this.tickInterceptor(t,{audio:[],state:"done"});const e=t-this.#a;if(t<this.#a||e>3e6)return this.#a=t,this.#o=Math.ceil(this.#a/1e6*N),await this.tickInterceptor(t,{audio:[new Float32Array(0),new Float32Array(0)],state:"success"});this.#a=t;const n=Math.ceil(e/1e6*N),r=this.#o+n,i=this.#r.loop?[D(this.#n,this.#o,r),D(this.#t,this.#o,r)]:[this.#n.slice(this.#o,r),this.#t.slice(this.#o,r)];return this.#o=r,await this.tickInterceptor(t,{audio:i,state:"success"})}async split(t){await this.ready;const e=Math.ceil(t/1e6*N);return[new st(this.getPCMData().map((t=>t.slice(0,e))),this.#r),new st(this.getPCMData().map((t=>t.slice(e))),this.#r)]}async clone(){await this.ready;const t=new st(this.getPCMData(),this.#r);return await t.ready,t}destroy(){this.#n=new Float32Array(0),this.#t=new Float32Array(0),m.info("---- audioclip destroy ----")}}class ct{static ctx=null;ready;#e={duration:0,width:0,height:0};get meta(){return{...this.#e}}#n=()=>{};audioTrack;#t=null;#r;constructor(t){this.#r=t,this.audioTrack=t.getAudioTracks()[0]??null,this.#e.duration=1/0;const e=t.getVideoTracks()[0];null!=e?(e.contentHint="motion",this.ready=new Promise((t=>{this.#n=function(t,e){let n,r=!1;return E(new MediaStreamTrackProcessor({track:t}).readable,{onChunk:async t=>{if(!r){const{displayHeight:i,displayWidth:a}=t,o=new OffscreenCanvas(a??0,i??0);n=o.getContext("2d"),e(o),r=!0}n.drawImage(t,0,0),t.close()},onDone:async()=>{}})}(e,(e=>{this.#e.width=e.width,this.#e.height=e.height,this.#t=e,t(this.meta)}))}))):this.ready=Promise.resolve(this.meta)}async tick(){return{video:null==this.#t?null:await createImageBitmap(this.#t),audio:[],state:"success"}}async split(){return[await this.clone(),await this.clone()]}async clone(){return new ct(this.#r.clone())}destroy(){this.#r.getTracks().forEach((t=>t.stop())),this.#n()}}class lt{ready;#e=[];#n={width:0,height:0,duration:0};get meta(){return{...this.#n}}#t={color:"#FFF",textBgColor:null,type:"srt",fontSize:30,letterSpacing:null,bottomOffset:30,fontFamily:"Noto Sans SC",strokeStyle:"#000",lineWidth:null,lineCap:null,lineJoin:null,textShadow:{offsetX:2,offsetY:2,blur:4,color:"#000"},videoWidth:1280,videoHeight:720,fontWeight:"normal",fontStyle:"normal"};#r;#i;#a=null;#o=0;#s=0;constructor(t,e){if(this.#e=Array.isArray(t)?t:(n=t,n.split(/\r|\n/).map((t=>t.trim())).filter((t=>t.length>0)).map((t=>({lineStr:t,match:t.match(/(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/)}))).filter((({lineStr:t},e,n)=>!(/^\d+$/.test(t)&&null!=n[e+1]?.match))).reduce(((t,{lineStr:e,match:n})=>{if(null==n){const n=t.at(-1);if(null==n)return t;n.text+=0===n.text.length?e:`\n${e}`}else t.push({start:dt(n[1]),end:dt(n[2]),text:""});return t}),[])).map((({start:t,end:e,text:n})=>({start:1e6*t,end:1e6*e,text:n}))),0===this.#e.length)throw Error("No subtitles content");var n;this.#t=Object.assign(this.#t,e),this.#s=null==e.textBgColor?0:.2*(e.fontSize??50);const{fontSize:r,fontFamily:i,fontWeight:a,fontStyle:o,videoWidth:s,videoHeight:c,letterSpacing:l}=this.#t;this.#o=r+2*this.#s,this.#r=new OffscreenCanvas(s,c),this.#i=this.#r.getContext("2d"),this.#i.font=`${o} ${a} ${r}px ${i}`,this.#i.textAlign="center",this.#i.textBaseline="top",this.#i.letterSpacing=l??"0px",this.#n={width:s,height:c,duration:this.#e.at(-1)?.end??0},this.ready=Promise.resolve(this.meta)}#c(t){const e=t.split("\n").reverse().map((t=>t.trim())),{width:n,height:r}=this.#r,{color:i,fontSize:a,textBgColor:o,textShadow:s,strokeStyle:c,lineWidth:l,lineCap:d,lineJoin:u,bottomOffset:h}=this.#t,p=this.#i;p.clearRect(0,0,n,r),p.globalAlpha=.6;let f=h;for(const t of e){const e=p.measureText(t),h=n/2;null!=o&&(p.shadowOffsetX=0,p.shadowOffsetY=0,p.shadowBlur=0,p.fillStyle=o,p.globalAlpha=.5,p.fillRect(h-e.actualBoundingBoxLeft-this.#s,r-f-this.#o,e.width+2*this.#s,this.#o)),p.shadowColor=s.color,p.shadowOffsetX=s.offsetX,p.shadowOffsetY=s.offsetY,p.shadowBlur=s.blur,p.globalAlpha=1,null!=c&&(p.lineWidth=l??a/6,null!=d&&(p.lineCap=d),null!=u&&(p.lineJoin=u),p.strokeStyle=c,p.strokeText(t,h,r-f-this.#o+this.#s)),p.fillStyle=i,p.fillText(t,h,r-f-this.#o+this.#s),f+=this.#o+.2*a}}async tick(t){if(null!=this.#a&&t>=this.#a.timestamp&&t<=this.#a.timestamp+(this.#a.duration??0))return{video:this.#a.clone(),state:"success"};let e=0;for(;e<this.#e.length&&!(t<=this.#e[e].end);e+=1);const n=this.#e[e]??this.#e.at(-1);if(t>n.end)return{state:"done"};if(t<n.start){this.#i.clearRect(0,0,this.#r.width,this.#r.height);const e=new VideoFrame(this.#r,{timestamp:t,duration:n.start-t});return this.#a?.close(),this.#a=e,{video:e.clone(),state:"success"}}this.#c(n.text);const r=new VideoFrame(this.#r,{timestamp:t,duration:n.end-t});return this.#a?.close(),this.#a=r,{video:r.clone(),state:"success"}}async split(t){await this.ready;let e=-1;for(let n=0;n<this.#e.length;n++){const r=this.#e[n];if(!(t>r.start)){e=n;break}}if(-1===e)throw Error("Not found subtitle by time");const n=this.#e.slice(0,e).map((t=>({...t})));let r=n.at(-1),i=null;null!=r&&r.end>t&&(i={start:0,end:r.end-t,text:r.text},r.end=t);const a=this.#e.slice(e).map((e=>({...e,start:e.start-t,end:e.end-t})));return null!=i&&a.unshift(i),[new lt(n,this.#t),new lt(a,this.#t)]}async clone(){return new lt(this.#e.slice(0),this.#t)}destroy(){this.#a?.close()}}function dt(t){const e=t.match(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/);if(null==e)throw Error(`time format error: ${t}`);return 60*Number(e[1])*60+60*Number(e[2])+Number(e[3])+Number(e[4])/1e3}class ut{readable;writable;#e=0;constructor(){const t=c.createFile();let e=!1;this.readable=new ReadableStream({start:e=>{t.onReady=n=>{const r=n.videoTracks[0]?.id;null!=r&&t.setExtractionOptions(r,"video",{nbSamples:100});const i=n.audioTracks[0]?.id;null!=i&&t.setExtractionOptions(i,"audio",{nbSamples:100}),e.enqueue({chunkType:"ready",data:{info:n,file:t}}),t.start()};const n={};t.onSamples=(r,i,a)=>{e.enqueue({chunkType:"samples",data:{id:r,type:i,samples:a.map((t=>({...t})))}}),n[r]=(n[r]??0)+a.length,t.releaseUsedSamples(r,n[r])},t.onFlush=()=>{e.close()}},cancel:()=>{t.stop(),e=!0}},{highWaterMark:50}),this.writable=new WritableStream({write:async n=>{if(e)return void this.writable.abort();const r=n.buffer;r.fileStart=this.#e,this.#e+=r.byteLength,t.appendBuffer(r)},close:()=>{t.flush(),t.stop(),t.onFlush?.()}})}}async function ht(t){const e=c.createFile(),n=function(t){let e=0;const n=t.boxes,r=[];let i=0;async function a(){const a=f(n,e);e=n.length,r.forEach((({track:e,id:n})=>{const r=e.samples.at(-1);null!=r&&(i=Math.max(i,r.cts+r.duration)),t.releaseUsedSamples(n,e.samples.length),e.samples=[]})),t.mdats=[],t.moofs=[],null!=a&&await(u?.write(a))}let o=[];function s(){if(o.length>0)return!0;const i=n.findIndex((t=>"moov"===t.type));if(-1===i)return!1;if(o=n.slice(0,i+1),e=i+1,0===r.length)for(let e=1;;e+=1){const n=t.getTrackById(e);if(null==n)break;r.push({track:n,id:e})}return!0}let l=0;const d=(0,I.fm)();let u=null;const h=(async()=>{u=await d.createWriter(),l=self.setInterval((()=>{s()&&a()}),100)})();let p=!1;return async()=>{if(p)throw Error("File exported");if(p=!0,await h,clearInterval(l),!s()||null==u)return null;t.flush(),await a(),await(u?.close());const e=o.find((t=>"moov"===t.type));if(null==e)return null;e.mvhd.duration=i;const n=(0,I.fm)(),r=f(o,0);return await(0,I.cW)(n,r),await(0,I.cW)(n,d,{overwrite:!1}),await n.stream()};function f(t,e){if(e>=t.length)return null;const n=new c.DataStream;n.endianness=c.DataStream.BIG_ENDIAN;for(let r=e;r<t.length;r++)null!==t[r]&&(t[r].write(n),delete t[r]);return new Uint8Array(n.buffer)}}(e);await async function(t,e){let n=0,r=0,i=0,a=0,o=0,s=0,c=null,l=null;for(const d of t){let t=null,u=null,h=null,p=null;if(await new Promise((async f=>{E(d.pipeThrough(new ut),{onDone:f,onChunk:async({chunkType:d,data:f})=>{if("ready"===d){const{videoTrackConf:t,audioTrackConf:r}=H(f.file,f.info);0===n&&null!=t&&(n=e.addTrack(t)),0===a&&null!=r&&(a=e.addTrack(r))}else if("samples"===d){const{type:d,samples:m}=f,y="video"===d?n:a,g="video"===d?r:o,w="video"===d?i:s;m.forEach((n=>{let r,i;"video"===d?(null===t&&(t=n.dts,u=n.cts),r=n.dts-t,i=n.cts-(u??0)):(null===h&&(h=n.dts,p=n.cts),r=n.dts-h,i=n.cts-(p??0)),e.addSample(y,n.data,{duration:n.duration,dts:r+g,cts:i+w,is_sync:n.is_sync})}));const x=m.at(-1);if(null==x)return;"video"===d?c=x:"audio"===d&&(l=x)}}})})),null!=c&&null!==t&&null!==u){const e=c.dts-t+c.duration,n=c.cts-u+c.duration;r+=e,i+=n}if(null!=l&&null!=c){const t=l.timescale/c.timescale;o=Math.round(r*t),s=Math.round(i*t)}}}(t,e);const r=await n();if(null==r)throw Error("Can not generate file from streams");return r}async function pt(t){return await ht([t])}function ft(t){let e=[];const n=new AudioDecoder({output:t=>{e.push(t)},error:m.error});return n.configure(t),{decode:async t=>{t.forEach((t=>{n.decode(new EncodedAudioChunk({type:t.is_sync?"key":"delta",timestamp:1e6*t.cts/t.timescale,duration:1e6*t.duration/t.timescale,data:t.data}))})),await n.flush();const r=e;return e=[],r},close:()=>{n.close()}}}function mt(t,e){const n={codec:t.codec,sampleRate:t.sampleRate,numberOfChannels:t.numberOfChannels},r=new AudioEncoder({output:t=>{e(function(t){const e=new ArrayBuffer(t.byteLength);t.copyTo(e);const n=t.timestamp;return{duration:t.duration??0,dts:n,cts:n,is_sync:"key"===t.type,data:e}}(t))},error:t=>{m.error("AudioEncoder error:",t,", config:",n)}});r.configure(n);let i=null;function a(e,n){return new AudioData({timestamp:n,numberOfChannels:t.numberOfChannels,numberOfFrames:e.length/t.numberOfChannels,sampleRate:t.sampleRate,format:"f32-planar",data:e})}return{encode:async(t,e)=>{null!=i&&r.encode(a(i.data,i.ts)),i={data:t,ts:e}},stop:async()=>{null!=i&&(function(t,e,n){const r=t.length-1,i=Math.min(n/2,r);for(let n=0;n<i;n++)for(let a=1;a<=e;a++)t[Math.floor(r/a)-n]*=n/i}(i.data,t.numberOfChannels,t.sampleRate),r.encode(a(i.data,i.ts)),i=null),await r.flush(),r.close()}}}function yt(t,e){m.info("mixinMP4AndAudio, opts:",{volume:e.volume,loop:e.loop});const n=c.createFile(),{stream:r,stop:i}=F(n,500);let a=null,o=null,s=[],l=0,d=0,u=0,h=!0,p=N;function f(t){const n=s.map((n=>e.loop?D(n,u,u+t):n.slice(u,u+t)));if(u+=t,1!==e.volume)for(const t of n)for(let n=0;n<t.length;n++)t[n]*=e.volume;return n}return E(t.pipeThrough(new ut),{onDone:async()=>{await(o?.stop()),a?.close(),i()},onChunk:async({chunkType:t,data:r})=>{if("ready"===t){const{videoTrackConf:t,audioTrackConf:i,audioDecoderConf:c}=H(r.file,r.info);0===l&&null!=t&&(l=n.addTrack(t));const u=i??{timescale:1e6,samplerate:p,channel_count:$,hdlr:"soun",name:"SoundHandler",type:"mp4a"};0===d&&(d=n.addTrack(u),p=i?.samplerate??p,h=null!=i);const f=new AudioContext({sampleRate:p});s=W(await f.decodeAudioData(await new Response(e.stream).arrayBuffer())),null!=c&&(a=ft(c)),o=mt(c??{codec:"mp4a"===u.type?j:u.type,numberOfChannels:u.channel_count,sampleRate:u.samplerate},(t=>n.addSample(d,t.data,t)))}else if("samples"===t){const{id:t,type:e,samples:i}=r;if("video"===e)return i.forEach((e=>n.addSample(t,e.data,e))),void(h||await async function(t){const e=t[0],n=t[t.length-1],r=Math.floor((n.cts+n.duration-e.cts)/n.timescale*p),i=V([f(r)]);0!==i.length&&o?.encode(i,e.cts/e.timescale*1e6)}(i));"audio"===e&&await async function(t){if(null==a)return;const e=(await a.decode(t)).map(_),n=function(t){const e=[];for(let n=0;n<t.length;n+=1)for(let r=0;r<t[n].length;r+=1)null==e[r]&&(e[r]=[]),e[r].push(t[n][r]);return e.map(L)}(e),r=f(n[0].length),i=t[0];o?.encode(V([n,r]),i.cts/i.timescale*1e6)}(i)}}}),r}const gt=[-1,1,-1,-1,1,-1,1,-1,1,1,-1,1],wt=[0,1,0,0,1,0,1,0,1,1,0,1];function xt(t,e,n){const r=t.createShader(e);if(t.shaderSource(r,n),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){const e=t.getShaderInfoLog(r);throw t.deleteShader(r),Error(e??"An error occurred compiling the shaders")}return r}function vt(t){const e="document"in globalThis?globalThis.document.createElement("canvas"):new OffscreenCanvas(t.width,t.height);e.width=t.width,e.height=t.height;const n=e.getContext("webgl2",{premultipliedAlpha:!1,alpha:!0});if(null==n)throw Error("Cant create gl context");const r=function(t,e,n){const r=xt(t,t.VERTEX_SHADER,e),i=xt(t,t.FRAGMENT_SHADER,n),a=t.createProgram();if(t.attachShader(a,r),t.attachShader(a,i),t.linkProgram(a),!t.getProgramParameter(a,t.LINK_STATUS))throw Error(t.getProgramInfoLog(a)??"Unable to initialize the shader program");return a}(n,"#version 300 es\n  layout (location = 0) in vec4 a_position;\n  layout (location = 1) in vec2 a_texCoord;\n  out vec2 v_texCoord;\n  void main () {\n    gl_Position = a_position;\n    v_texCoord = a_texCoord;\n  }\n","#version 300 es\nprecision mediump float;\nout vec4 FragColor;\nin vec2 v_texCoord;\n\nuniform sampler2D frameTexture;\nuniform vec3 keyColor;\n\n// 色度的相似度计算\nuniform float similarity;\n// 透明度的平滑度计算\nuniform float smoothness;\n// 降低绿幕饱和度，提高抠图准确度\nuniform float spill;\n\nvec2 RGBtoUV(vec3 rgb) {\n  return vec2(\n    rgb.r * -0.169 + rgb.g * -0.331 + rgb.b *  0.5    + 0.5,\n    rgb.r *  0.5   + rgb.g * -0.419 + rgb.b * -0.081  + 0.5\n  );\n}\n\nvoid main() {\n  // 获取当前像素的rgba值\n  vec4 rgba = texture(frameTexture, v_texCoord);\n  // 计算当前像素与绿幕像素的色度差值\n  vec2 chromaVec = RGBtoUV(rgba.rgb) - RGBtoUV(keyColor);\n  // 计算当前像素与绿幕像素的色度距离（向量长度）, 越相像则色度距离越小\n  float chromaDist = sqrt(dot(chromaVec, chromaVec));\n  // 设置了一个相似度阈值，baseMask为负，则表明是绿幕，为正则表明不是绿幕\n  float baseMask = chromaDist - similarity;\n  // 如果baseMask为负数，fullMask等于0；baseMask为正数，越大，则透明度越低\n  float fullMask = pow(clamp(baseMask / smoothness, 0., 1.), 1.5);\n  rgba.a = fullMask; // 设置透明度\n  // 如果baseMask为负数，spillVal等于0；baseMask为整数，越小，饱和度越低\n  float spillVal = pow(clamp(baseMask / spill, 0., 1.), 1.5);\n  float desat = clamp(rgba.r * 0.2126 + rgba.g * 0.7152 + rgba.b * 0.0722, 0., 1.); // 计算当前像素的灰度值\n  rgba.rgb = mix(vec3(desat, desat, desat), rgba.rgb, spillVal);\n  FragColor = rgba;\n}\n");n.useProgram(r),n.uniform3fv(n.getUniformLocation(r,"keyColor"),t.keyColor.map((t=>t/255))),n.uniform1f(n.getUniformLocation(r,"similarity"),t.similarity),n.uniform1f(n.getUniformLocation(r,"smoothness"),t.smoothness),n.uniform1f(n.getUniformLocation(r,"spill"),t.spill);const i=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,i),n.bufferData(n.ARRAY_BUFFER,new Float32Array(gt),n.STATIC_DRAW);const a=n.getAttribLocation(r,"a_position");n.vertexAttribPointer(a,2,n.FLOAT,!1,2*Float32Array.BYTES_PER_ELEMENT,0),n.enableVertexAttribArray(a);const o=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,o),n.bufferData(n.ARRAY_BUFFER,new Float32Array(wt),n.STATIC_DRAW);const s=n.getAttribLocation(r,"a_texCoord");return n.vertexAttribPointer(s,2,n.FLOAT,!1,2*Float32Array.BYTES_PER_ELEMENT,0),n.enableVertexAttribArray(s),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,1),{cvs:e,gl:n}}function bt(t){return t instanceof VideoFrame?{width:t.codedWidth,height:t.codedHeight}:{width:t.width,height:t.height}}const St=t=>{let e=null,n=null,r=t.keyColor,i=null;return async a=>{if((null==e||null==n||null==i)&&(null==r&&(r=function(t){const e=new OffscreenCanvas(1,1).getContext("2d");e.drawImage(t,0,0);const{data:[n,r,i]}=e.getImageData(0,0,1,1);return[n,r,i]}(a)),({cvs:e,gl:n}=vt({...bt(a),keyColor:r,...t})),i=function(t){const e=t.createTexture();if(null==e)throw Error("Create WebGL texture error");t.bindTexture(t.TEXTURE_2D,e);const n=t.RGBA,r=t.RGBA,i=t.UNSIGNED_BYTE,a=new Uint8Array([0,0,255,255]);return t.texImage2D(t.TEXTURE_2D,0,n,1,1,0,r,i,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),e}(n)),function(t,e,n){t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.drawArrays(t.TRIANGLES,0,6)}(n,a,i),null!=globalThis.VideoFrame&&a instanceof globalThis.VideoFrame){const t=new VideoFrame(e,{alpha:"keep",timestamp:a.timestamp,duration:a.duration??void 0});return a.close(),t}return createImageBitmap(e,{imageOrientation:a instanceof ImageBitmap?"flipY":"none"})}};class Ct{#e=new l;on=this.#e.on;#n=0;get x(){return this.#n}set x(t){this.#o("x",t)}#t=0;get y(){return this.#t}set y(t){this.#o("y",t)}#r=0;get w(){return this.#r}set w(t){this.#o("w",t)}#i=0;get h(){return this.#i}set h(t){this.#o("h",t)}#a=0;get angle(){return this.#a}set angle(t){this.#o("angle",t)}#o(t,e){const n=this[t]!==e;switch(t){case"x":this.#n=e;break;case"y":this.#t=e;break;case"w":this.#r=e;break;case"h":this.#i=e;break;case"angle":this.#a=e}n&&this.#e.emit("propsChange",{[t]:e})}#s=null;constructor(t,e,n,r,i){this.x=t??0,this.y=e??0,this.w=n??0,this.h=r??0,this.#s=i??null}get center(){const{x:t,y:e,w:n,h:r}=this;return{x:t+n/2,y:e+r/2}}fixedAspectRatio=!1;fixedScaleCenter=!1;clone(){const{x:t,y:e,w:n,h:r}=this,i=new Ct(t,e,n,r,this.#s);return i.angle=this.angle,i.fixedAspectRatio=this.fixedAspectRatio,i.fixedScaleCenter=this.fixedScaleCenter,i}checkHit(t,e){let{angle:n,center:r,x:i,y:a,w:o,h:s}=this;const c=this.#s?.center??r,l=this.#s?.angle??n;null==this.#s&&(i-=c.x,a-=c.y);const d=t-c.x,u=e-c.y;let h=d,p=u;return 0!==l&&(h=d*Math.cos(l)+u*Math.sin(l),p=u*Math.cos(l)-d*Math.sin(l)),!(h<i||h>i+o||p<a||p>a+s)}}const kt={fadeIn:(t,e,{duration:n})=>{const r=structuredClone(e);return r.opacity=.1,t.to(r,{duration:n,opacity:e.opacity,ease:"power1.inOut"}),r},zoomFadeInGrow:(t,e,{duration:n})=>{const r=structuredClone(e);r.opacity=.1;const i=e.rect.w-.5*e.rect.w,a=e.rect.h-.5*e.rect.h;return r.rect.w=.5*e.rect.w,r.rect.h=.5*e.rect.h,r.rect.x=e.rect.x+i/2,r.rect.y=e.rect.y+a/2,t.to(r,{duration:n,opacity:e.opacity,ease:"power1.inOut"}),t.to(r.rect,{duration:n,w:e.rect.w,h:e.rect.h,x:e.rect.x,y:e.rect.y,ease:"power1.inOut"},0),r},zoomFadeInShrink:(t,e,{duration:n})=>{const r=structuredClone(e);r.opacity=.1;const i=1.5*e.rect.w-e.rect.w,a=1.5*e.rect.h-e.rect.h;return r.rect.w=1.5*e.rect.w,r.rect.h=1.5*e.rect.h,r.rect.x=e.rect.x-i/2,r.rect.y=e.rect.y-a/2,t.to(r,{duration:n,opacity:e.opacity,ease:"power1.inOut"}),t.to(r.rect,{duration:n,w:e.rect.w,h:e.rect.h,x:e.rect.x,y:e.rect.y,ease:"power1.inOut"},0),r},slideFadeInUp:(t,e,{duration:n})=>{const r=structuredClone(e);return r.opacity=.1,r.rect.y=e.rect.y+e.rect.h,t.to(r,{duration:n,opacity:e.opacity,ease:"power1.inOut"}),t.to(r.rect,{duration:n,y:e.rect.y,ease:"power1.inOut"},0),r},slideFadeInDown:(t,e,{duration:n})=>{const r=structuredClone(e);return r.opacity=.1,r.rect.y=e.rect.y-e.rect.h,t.to(r,{duration:n,opacity:e.opacity,ease:"power1.inOut"}),t.to(r.rect,{duration:n,y:e.rect.y,ease:"power1.inOut"},0),r},slideInLeft:(t,e,{duration:n})=>{const r=structuredClone(e);return r.rect.x=e.rect.x-e.rect.w,t.to(r.rect,{duration:n,x:e.rect.x,ease:"power1.inOut"}),r},slideInRight:(t,e,{duration:n})=>{const r=structuredClone(e);return r.rect.x=e.rect.x+e.rect.w,t.to(r.rect,{duration:n,x:e.rect.x,ease:"power1.inOut"}),r}},Tt={fadeOut:(t,e,{duration:n,delay:r})=>{const i=structuredClone(e);return t.to(i,{duration:n,opacity:.1,ease:"power1.inOut"},r),i},zoomFadeOutGrow:(t,e,{duration:n,delay:r})=>{const i=structuredClone(e);t.to(i,{duration:n,opacity:.1,ease:"power1.inOut"},r);const a=1.2*e.rect.w-e.rect.w,o=1.2*e.rect.h-e.rect.h;return t.to(i.rect,{duration:n,w:1.2*e.rect.w,h:1.2*e.rect.h,x:e.rect.x-a/2,y:e.rect.y-o/2,ease:"power1.inOut"},r),i},zoomFadeOutShrink:(t,e,{duration:n,delay:r})=>{const i=structuredClone(e);t.to(i,{duration:n,opacity:.1,ease:"power1.inOut"},r);const a=e.rect.w-.8*e.rect.w,o=e.rect.h-.8*e.rect.h;return t.to(i.rect,{duration:n,w:.8*e.rect.w,h:.8*e.rect.h,x:e.rect.x+a/2,y:e.rect.y+o/2,ease:"power1.inOut"},r),i},slideFadeOutUp:(t,e,{duration:n,delay:r})=>{const i=structuredClone(e);return t.to(i,{duration:n,opacity:.1,ease:"power1.inOut"},r),t.to(i.rect,{duration:n,y:e.rect.y-e.rect.h,ease:"power1.inOut"},r),i},slideFadeOutDown:(t,e,{duration:n,delay:r})=>{const i=structuredClone(e);return t.to(i,{duration:n,opacity:.1,ease:"power1.inOut"},r),t.to(i.rect,{duration:n,y:e.rect.y+e.rect.h,ease:"power1.inOut"},r),i},slideOutLeft:(t,e,{duration:n,delay:r})=>{const i=structuredClone(e);return t.to(i.rect,{duration:n,x:e.rect.x-e.rect.w,ease:"power1.inOut"},r),i},slideOutRight:(t,e,{duration:n,delay:r})=>{const i=structuredClone(e);return t.to(i.rect,{duration:n,x:e.rect.x+e.rect.w,ease:"power1.inOut"},r),i}};function At(t){const{x:e,y:n,w:r,h:i,angle:a}=t.rect;return{rect:{x:e,y:n,w:r,h:i,angle:a},opacity:t.opacity,time:t.time}}class Et{rect=new Ct;#e={offset:0,duration:0,playbackRate:1};get time(){return this.#e}set time(t){Object.assign(this.#e,t)}#n=new l;on=this.#n.on;#t=0;get zIndex(){return this.#t}set zIndex(t){const e=this.#t!==t;this.#t=t,e&&this.#n.emit("propsChange",{zIndex:t})}opacity=1;flip=null;#r=[];#i=null;ready=Promise.resolve();constructor(){this.rect.on("propsChange",(t=>{this.#n.emit("propsChange",{rect:t})}))}_render(t,{rect:e,opacity:n}){const{center:r,angle:i}=e;t.setTransform("horizontal"===this.flip?-1:1,0,0,"vertical"===this.flip?-1:1,r.x,r.y),t.rotate((null==this.flip?1:-1)*i),t.globalAlpha=n}setAnimation(t,e){if(void 0===e)return void(null==t?this.#i=null:("in"in t||"out"in t)&&(this.#i=t));const n=t,r=e;this.#r.push({keyFrame:Object.entries(n).map((([t,e])=>{const n={from:0,to:100}[t]??Number(t.slice(0,-1));if(isNaN(n)||n>100||n<0)throw Error("keyFrame must between 0~100");return[n/100,e]})),conf:{duration:r.duration,delay:r.delay??0,iterCount:r.iterCount??1/0,totalDuration:r.duration*(r.iterCount??1/0)}})}animate(t){const e={rect:this.rect.clone(),opacity:this.opacity};if(this.#i&&("in"in this.#i||"out"in this.#i)){const n=function(t,e,n){const r=e/1e6,i=t.time.duration/1e6;if(r<0||r>i)return At(t);const a=O.p8.timeline({paused:!0});let o=At(t);if(n.in){const t=(n.in.duration??1e6)/1e6,e=kt[n.in.type];r<=t&&(o=e(a,o,{duration:t}))}if(n.out){const t=(n.out.duration??1e6)/1e6,e=i-t;r>=e&&(o=(0,Tt[n.out.type])(a,o,{duration:t,delay:e}))}return a.to({},{duration:i},0),a.progress(Math.min(r/i,1)),o}(this,t,this.#i);return Object.assign(e.rect,n.rect),e.opacity=n.opacity,e}if(0===this.#r.length)return e;for(const{keyFrame:n,conf:r}of this.#r){if(t<r.delay||t>r.delay+r.totalDuration)continue;const i=Ft(t,n,r);for(const t in i)switch(t){case"opacity":e.opacity=i[t];break;case"x":case"y":case"w":case"h":case"angle":e.rect[t]=i[t]}return e}return e}copyStateTo(t){t.#r=[...this.#r],t.#i=null==this.#i?null:{...this.#i},t.zIndex=this.zIndex,t.opacity=this.opacity,t.flip=this.flip,t.rect=this.rect.clone(),t.time={...this.time}}destroy(){this.#n.destroy()}}function Ft(t,e,n){const r=t-n.delay,i=r%n.duration,a=r/n.duration>=n.iterCount||r===n.duration?1:i/n.duration,o=e.findIndex((t=>t[0]>=a));if(-1===o)return{};const s=e[o-1],c=e[o],l=c[1];if(null==s)return l;const d=s[1],u={},h=(a-s[0])/(c[0]-s[0]);for(const t in l){const e=t;null!=d[e]&&(u[e]=(l[e]-d[e])*h+d[e])}return u}class Rt extends Et{#e;getClip(){return this.#e}#n=null;#t=!1;constructor(t){super(),this.#e=t,this.ready=t.ready.then((({width:t,height:e,duration:n})=>{this.rect.w=0===this.rect.w?t:this.rect.w,this.rect.h=0===this.rect.h?e:this.rect.h,this.time.duration=0===this.time.duration?n:this.time.duration}))}async offscreenRender(t,e){const n=e*this.time.playbackRate,r=this.animate(n);super._render(t,r);const{w:i,h:a}=r.rect,{video:o,audio:s,state:c}=await this.#e.tick(n);let l=s??[];if(null!=s&&1!==this.time.playbackRate&&(l=s.map((t=>U(t,this.time.playbackRate)))),"done"===c||n>this.time.duration)return{audio:l,done:!0};const d=o??this.#n;return null!=d&&t.drawImage(d,-i/2,-a/2,i,a),null!=o&&(this.#n?.close(),this.#n=o),{audio:l,done:!1}}async clone(){const t=new Rt(await this.#e.clone());return await t.ready,this.copyStateTo(t),t}destroy(){this.#t||(this.#t=!0,m.info("OffscreenSprite destroy"),super.destroy(),this.#n?.close(),this.#n=null,this.#e.destroy())}}class It extends Et{#e;getClip(){return this.#e}visible=!0;constructor(t){super(),this.#e=t,this.ready=t.ready.then((({width:t,height:e,duration:n})=>{this.rect.w=0===this.rect.w?t:this.rect.w,this.rect.h=0===this.rect.h?e:this.rect.h,this.time.duration=0===this.time.duration?n:this.time.duration}))}#n=null;#t=[];#r=!1;async#i(t){if(!this.#r){this.#r=!0;try{const{video:e,audio:n}=await this.#e.tick(t*this.time.playbackRate);if(this.#o)return void e?.close();null!=e&&(this.#n?.close(),this.#n=e??null),this.#t=n??[],null!=n&&1!==this.time.playbackRate&&(this.#t=n.map((t=>U(t,this.time.playbackRate))))}finally{this.#r=!1}}}async preFrame(t){this.#a!==t&&(await this.#i(t),this.#a=t)}#a=-1;render(t,e){const n=this.animate(e);super._render(t,n);const{w:r,h:i}=n.rect;this.#a!==e&&this.#i(e),this.#a=e;const a=this.#t;this.#t=[];const o=this.#n;return null!=o&&t.drawImage(o,-r/2,-i/2,r,i),{audio:a}}copyStateTo(t){super.copyStateTo(t),t instanceof It&&(t.visible=this.visible)}#o=!1;destroy(){this.#o||(this.#o=!0,m.info("VisibleSprite destroy"),super.destroy(),this.#n?.close(),this.#n=null,this.#e.destroy())}}let Mt=0;async function Ot(t){t()>50&&(await z(15),await Ot(t))}class Pt{static async isSupported(t={}){return(null!=self.OffscreenCanvas&&null!=self.VideoEncoder&&null!=self.VideoDecoder&&null!=self.VideoFrame&&null!=self.AudioEncoder&&null!=self.AudioDecoder&&null!=self.AudioData&&((await self.VideoEncoder.isConfigSupported({codec:t.videoCodec??"avc1.42E032",width:t.width??1920,height:t.height??1080,bitrate:t.bitrate??7e6})).supported??!1)&&(await self.AudioEncoder.isConfigSupported({codec:j,sampleRate:N,numberOfChannels:$})).supported)??!1}#e=m.create(`id:${Mt++},`);#n=!1;#t=[];#r;#i;#a=null;#o;#s;#c=new l;on=this.#c.on;constructor(t={}){const{width:e=0,height:n=0}=t;this.#r=new OffscreenCanvas(e,n);const r=this.#r.getContext("2d",{alpha:!1});if(null==r)throw Error("Can not create 2d offscreen context");this.#i=r,this.#o=Object.assign({bgColor:"#000",width:0,height:0,videoCodec:"avc1.42E032",audio:!0,bitrate:5e6,fps:30,metaDataTags:null},t),this.#s=e*n>0}async addSprite(t,e={}){const n={rect:Bt(["x","y","w","h"],t.rect),time:{...t.time},zIndex:t.zIndex};this.#e.info("Combinator add sprite",n);const r=await t.clone();this.#e.info("Combinator add sprite ready"),this.#t.push(Object.assign(r,{main:e.main??!1,expired:!1})),this.#t.sort(((t,e)=>t.zIndex-e.zIndex))}#l(t){const{fps:e,width:n,height:r,videoCodec:i,bitrate:a,audio:o,metaDataTags:s}=this.#o;return C({video:this.#s?{width:n,height:r,expectFPS:e,codec:i,bitrate:a,__unsafe_hardwareAcceleration__:this.#o.__unsafe_hardwareAcceleration__}:null,audio:!1===o?null:{codec:"aac",sampleRate:N,channelCount:$},duration:t,metaDataTags:s})}output(){if(0===this.#t.length)throw Error("No sprite added");const t=this.#t.find((t=>t.main)),e=null!=t?t.time.offset+t.time.duration:Math.max(...this.#t.map((t=>t.time.offset+t.time.duration)));if(e===1/0)throw Error("Unable to determine the end time, please specify a main sprite, or limit the duration of ImgClip, AudioCli");-1===e&&this.#e.warn("Unable to determine the end time, process value don't update"),this.#e.info(`start combinate video, maxTime:${e}`);const n=this.#l(e);let r=performance.now();const i=this.#d(n,e,{onProgress:t=>{this.#e.debug("OutputProgress:",t),this.#c.emit("OutputProgress",t)},onEnded:async()=>{await n.flush(),this.#e.info("===== output ended =====, cost:",performance.now()-r),this.#c.emit("OutputProgress",1),this.destroy()},onError:t=>{this.#c.emit("error",t),o(t),this.destroy()}});this.#a=()=>{i(),n.close(),o()};const{stream:a,stop:o}=F(n.mp4file,500,this.destroy);return a}destroy(){this.#n||(this.#n=!0,this.#a?.(),this.#c.destroy())}#d(t,e,{onProgress:n,onEnded:r,onError:i}){let a=0;const o={aborted:!1};let s=null;(async()=>{const{fps:n,bgColor:i,audio:c}=this.#o,d=Math.round(1e6/n),u=this.#i,h=function(t){const{ctx:e,bgColor:n,sprites:r,aborter:i}=t,{width:a,height:o}=e.canvas;return async t=>{e.fillStyle=n,e.fillRect(0,0,a,o);const s=[];let c=!1;for(const n of r){if(i.aborted)break;if(t<n.time.offset||n.expired)continue;e.save();const{audio:r,done:a}=await n.offscreenRender(e,t-n.time.offset);s.push(r),e.restore(),(n.time.duration>0&&t>n.time.offset+n.time.duration||a)&&(n.main&&(c=!0),n.destroy(),n.expired=!0)}return{audios:s,mainSprDone:c}}}({ctx:u,bgColor:i,sprites:this.#t,aborter:o}),p=function(t){const{ctx:e,cvs:n,outputAudio:r,remux:i,hasVideoTrack:a,timeSlice:o}=t,{width:s,height:c}=n;let l=0;const d=Math.floor(3*t.fps),u=function(t){const e=t*$,n=new Float32Array(3*e);let r=0,i=0;const a=t/N*1e6,o=new Float32Array(e),s=s=>{let c=0;const l=Math.floor(r/e),d=[];for(let r=0;r<l;r++)d.push(new AudioData({timestamp:i,numberOfChannels:$,numberOfFrames:t,sampleRate:N,format:"f32",data:n.subarray(c,c+e)})),c+=e,i+=a;for(n.set(n.subarray(c,r),0),r-=c;s-i>a;)d.push(new AudioData({timestamp:i,numberOfChannels:$,numberOfFrames:t,sampleRate:N,format:"f32",data:o})),i+=a;return d};return(t,e)=>{const i=Math.max(...e.map((t=>t[0]?.length??0)));for(let t=0;t<i;t++){let i=0,a=0;for(let n=0;n<e.length;n++){const r=e[n][0]?.[t]??0;i+=r,a+=e[n][1]?.[t]??r}n[r]=i,n[r+1]=a,r+=2}return s(t)}}(1024);return(t,h)=>{if(!1!==r)for(const e of u(t,h))i.encodeAudio(e);if(a){const r=new VideoFrame(n,{duration:o,timestamp:t});i.encodeVideo(r,{keyFrame:l%d==0}),e.resetTransform(),e.clearRect(0,0,s,c),l+=1}}}({remux:t,ctx:u,cvs:this.#r,outputAudio:c,hasVideoTrack:this.#s,timeSlice:d,fps:n});let f=0;for(;;){if(null!=s)return;if(o.aborted||-1!==e&&f>e||0===this.#t.length)return l(),void await r();a=f/e;const{audios:n,mainSprDone:i}=await h(f);if(i)return l(),void await r();if(o.aborted)return;p(f,n),f+=d,await Ot(t.getEncodeQueueSize)}})().catch((t=>{s=t,this.#e.error(t),l(),i(t)}));const c=setInterval((()=>{n(a)}),500),l=()=>{o.aborted||(o.aborted=!0,clearInterval(c),this.#t.forEach((t=>t.destroy())))};return l}}function Bt(t,e){return t.reduce(((t,n)=>(t[n]=e[n],t)),{})}function Lt(t){var e=null,n=null;return function(r){var i;if(null==e||null==n){var a=function(t,e){var n=new OffscreenCanvas(t,e);n.width=t,n.height=e;var r=n.getContext("2d",{alpha:!0});return{cvs:n,ctx:r}}(r.displayWidth,r.displayHeight);e=a.cvs,n=a.ctx}n.clearRect(0,0,e.width,e.height),n.filter=t,n.drawImage(r,0,0);var o=new VideoFrame(e,{timestamp:r.timestamp,duration:null!==(i=r.duration)&&void 0!==i?i:0});return r.close(),o}}var _t=n(24325),Wt=n.n(_t);function Vt(t,e){return zt.apply(this,arguments)}function zt(){return zt=s()(a()().mark((function t(e,n){var r,i,o,c,l,d,u,h,p,f;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.ready;case 2:if(r=t.sent,i=r.width,o=r.height,c=r.duration,l=0,d=0,u=0,h=0,"number"==typeof n){t.next=22;break}if(!((p=n).x<0||p.y<0||p.w<=0||p.h<=0)){t.next=14;break}throw new Error("Invalid crop area parameters: coordinates cannot be negative, width and height must be greater than 0");case 14:if(!(p.x+p.w>i||p.y+p.h>o)){t.next=16;break}throw new Error("Crop area exceeds original dimensions: original size(".concat(i,"x").concat(o,"), crop area(").concat(p.x,",").concat(p.y,",").concat(p.w,",").concat(p.h,")"));case 16:l=2*Math.floor(p.x/2),d=2*Math.floor(p.y/2),u=2*Math.floor(p.w/2),h=2*Math.floor(p.h/2),t.next=28;break;case 22:i/o>n?(h=2*Math.floor(o/2),u=2*Math.floor(h*n/2),u=Math.min(u,i),l=2*Math.floor((i-u)/2/2)):(u=2*Math.floor(i/2),h=2*Math.floor(u/n/2),h=Math.min(h,o),d=2*Math.floor((o-h)/2/2)),l=Math.max(0,Math.min(l,i-u)),d=Math.max(0,Math.min(d,o-h)),u=Math.min(u,i-l),h=Math.min(h,o-d);case 28:return f=e.tickInterceptor,e.tickInterceptor=function(){var t=s()(a()().mark((function t(e,n){var r,i,o;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,f(e,n);case 2:if((i=t.sent).video){t.next=5;break}return t.abrupt("return",i);case 5:if(!(i.video instanceof VideoFrame)){t.next=9;break}t.t0=new VideoFrame(i.video,{timestamp:i.video.timestamp,duration:null!==(r=i.video.duration)&&void 0!==r?r:0,visibleRect:{x:l,y:d,width:u,height:h}}),t.next=12;break;case 9:return t.next=11,createImageBitmap(i.video,l,d,u,h);case 11:t.t0=t.sent;case 12:return o=t.t0,i.video.close(),t.abrupt("return",Wt()(Wt()({},i),{},{video:o}));case 15:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),e.ready=Promise.resolve({width:u,height:h,duration:c}),t.abrupt("return",e);case 32:case"end":return t.stop()}}),t)}))),zt.apply(this,arguments)}var Dt=n(14582),Ut=n.n(Dt),Nt=n(93949),$t=n.n(Nt),jt=n(6270),Ht=n.n(jt),Yt=n(29861),Gt=n.n(Yt),Xt=n(73998),Qt=n.n(Xt),Jt=n(56743),Kt=n.n(Jt),qt=n(67581),Zt=n.n(qt),te=n(99869),ee=n(58878);function ne(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;t.pivot.set(t.width*e,t.height*n),t.position.set(t.x+t.width*e,t.y+t.height*n)}var re={fadeIn:function(t,e,n){var r=e.container,i=n.duration;r.alpha=0,t.to(r,{duration:i,pixi:{alpha:1},ease:"power1.inOut"})},zoomFadeInGrow:function(t,e,n){var r=e.container,i=n.duration;ne(r),r.alpha=0,r.scale.set(.5,.5),t.to(r,{duration:i,pixi:{alpha:1,scaleX:1,scaleY:1},ease:"power1.inOut"})},zoomFadeInShrink:function(t,e,n){var r=e.container,i=n.duration;ne(r),r.alpha=0,r.scale.set(1.5,1.5),t.to(r,{duration:i,pixi:{alpha:1,scaleX:1,scaleY:1},ease:"power1.inOut"})},slideFadeInUp:function(t,e,n){var r=e.container,i=n.duration;r.alpha=0,r.y+=r.height,t.to(r,{duration:i,pixi:{alpha:1,y:r.y-r.height},ease:"power1.inOut"})},slideFadeInDown:function(t,e,n){var r=e.container,i=n.duration;r.alpha=0,r.y-=r.height,t.to(r,{duration:i,pixi:{alpha:1,y:r.y+r.height},ease:"power1.inOut"})},slideInLeft:function(t,e,n){var r=e.container,i=n.duration,a=r.x;r.x-=r.width,r.mask=(new ee.TCu).rect(a,r.y,r.width,r.height).fill(),t.to(r,{duration:i,pixi:{x:a},ease:"power1.inOut"})},slideInRight:function(t,e,n){var r=e.container,i=n.duration,a=r.x;r.x+=r.width,r.mask=(new ee.TCu).rect(a,r.y,r.width,r.height).fill(),t.to(r,{duration:i,pixi:{x:a},ease:"power1.inOut"})},wordEmphasize:function(t,e){e.words.forEach((function(e){var n=e.pixiText,r=e.ts,i=(r[1]-r[0])/2;ne(n,.5,1),t.to(n,{duration:2*i,pixi:{scaleX:1.2,scaleY:1.2},ease:"power1.inOut"},r[0]),t.to(n,{duration:2*i,pixi:{scaleX:1,scaleY:1},ease:"power1.inOut"},r[0]+2*i)}))},wordTyping:function(t,e,n){for(var r=e.words,i=n.duration/r.length,a=0;a<r.length;a++){var o=r[a].pixiText;o.alpha=0,t.to(o,{duration:i,pixi:{alpha:1},ease:"steps(1)"},i*a)}}},ie={fadeOut:function(t,e,n){var r=e.container,i=n.duration,a=n.delay;t.to(r,{duration:i,pixi:{alpha:0},ease:"power1.inOut"},a)},zoomFadeOutGrow:function(t,e,n){var r=e.container,i=n.duration,a=n.delay;t.to(r,{duration:i,pixi:{alpha:0,scaleX:1.2,scaleY:1.2},ease:"power1.inOut"},a)},zoomFadeOutShrink:function(t,e,n){var r=e.container,i=n.duration,a=n.delay;t.to(r,{duration:i,pixi:{alpha:0,scaleX:.8,scaleY:.8},ease:"power1.inOut"},a)},slideFadeOutUp:function(t,e,n){var r=e.container,i=e.originCtnrRect,a=n.duration,o=n.delay;t.to(r,{duration:a,pixi:{alpha:0,y:i.y-i.h},ease:"power1.inOut"},o)},slideFadeOutDown:function(t,e,n){var r=e.container,i=e.originCtnrRect,a=n.duration,o=n.delay;t.to(r,{duration:a,pixi:{alpha:0,y:i.y+i.h},ease:"power1.inOut"},o)},slideOutLeft:function(t,e,n){var r=e.container,i=e.originCtnrRect,a=n.duration,o=n.delay;t.to(r,{duration:a,pixi:{x:i.x-i.w},ease:"power1.inOut"},o)},slideOutRight:function(t,e,n){var r=e.container,i=e.originCtnrRect,a=n.duration,o=n.delay;t.to(r,{duration:a,pixi:{x:i.x+i.w},ease:"power1.inOut"},o)}};O.p8.registerPlugin(te.w),te.w.registerPIXI({Application:ee.MxU,Assets:ee.deM,Container:ee.W20,Sprite:ee.jyi,Text:ee.xvT});var ae=new WeakMap,oe=new WeakMap,se=new WeakMap,ce=new WeakMap,le=new WeakMap,de=new WeakMap,ue=function(){function t(e,n){var r=this;$t()(this,t),Qt()(this,ae,{writable:!0,value:void 0}),Gt()(this,"ready",void 0),Qt()(this,oe,{writable:!0,value:{duration:0,width:0,height:0}}),Qt()(this,se,{writable:!0,value:[]}),Qt()(this,ce,{writable:!0,value:void 0}),Qt()(this,le,{writable:!0,value:void 0}),Qt()(this,de,{writable:!0,value:new Map}),Kt()(this,ce,n),Kt()(this,se,e),Kt()(this,ae,new OffscreenCanvas(n.videoWidth,n.videoHeight)),Kt()(this,le,new ee.MxU),this.ready=Zt()(this,le).init({view:Zt()(this,ae),width:n.videoWidth,height:n.videoHeight,backgroundAlpha:0}).then((function(){return Zt()(r,oe).width=n.videoWidth,Zt()(r,oe).height=n.videoHeight,Zt()(r,oe).duration=e[e.length-1].endTime,r.buildScene(),r.meta}))}var e,n;return Ht()(t,[{key:"meta",get:function(){return Wt()({},Zt()(this,oe))}},{key:"tick",value:(n=s()(a()().mark((function t(e){var n,r,i,o,s,c,l,d,u,h,p,f,m,y,g;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(e>Zt()(this,oe).duration)){t.next=5;break}return t.next=3,createImageBitmap(Zt()(this,ae));case 3:return t.t0=t.sent,t.abrupt("return",{state:"done",video:t.t0});case 5:n={},r=[],i=Ut()(Zt()(this,se)),t.prev=8,i.s();case 10:if((o=i.n()).done){t.next=32;break}if(s=o.value,c=Zt()(this,de).get(s.id)){t.next=15;break}return t.abrupt("continue",30);case 15:if(l=e>=s.startTime&&e<=s.endTime,c.container.visible=l,l){t.next=19;break}return t.abrupt("continue",30);case 19:c.container.scale={x:1,y:1},d=0,u=Ut()(c.words);try{for(u.s();!(h=u.n()).done;)(p=h.value).pixiText.scale={x:1,y:1},p.pixiText.x=d,p.pixiText.y=0,d+=p.pixiText.width}catch(t){u.e(t)}finally{u.f()}c.container.x=null==s.x?(Zt()(this,ae).width-c.container.width)/2:s.x,c.container.y=null==s.y?.8*Zt()(this,ae).height:s.y,f=.1*c.container.height+c.maxEffectWidth,n[s.id]=new Ct(c.container.x-f,c.container.y-f,c.container.width+2*f,c.container.height+2*f),he(m=O.p8.timeline(),c.container,s,c.words,e),r.push(m);case 30:t.next=10;break;case 32:t.next=37;break;case 34:t.prev=34,t.t1=t.catch(8),i.e(t.t1);case 37:return t.prev=37,i.f(),t.finish(37);case 40:for(Zt()(this,le).render(),y=0,g=r;y<g.length;y++)g[y].kill();return t.next=44,createImageBitmap(Zt()(this,ae));case 44:return t.t2=t.sent,t.t3=n,t.abrupt("return",{state:"success",video:t.t2,contentRects:t.t3});case 47:case"end":return t.stop()}}),t,this,[[8,34,37,40]])}))),function(t){return n.apply(this,arguments)})},{key:"clone",value:(e=s()(a()().mark((function e(){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new t(Zt()(this,se),Zt()(this,ce)));case 1:case"end":return e.stop()}}),e,this)}))),function(){return e.apply(this,arguments)})},{key:"buildScene",value:function(){var t=this;Zt()(this,se).forEach((function(e){var n=new ee.W20,r=new ee.pn8(e.defaultStyle),i=0,a=e.words.map((function(t){var e,a,o,s,c,l,d=new ee.xvT({text:t.word,style:null!=t.style?new ee.pn8(t.style):r});n.addChild(d);var u=d.style;return i=Math.max(i,null!==(e=null===(a=u.stroke)||void 0===a?void 0:a.width)&&void 0!==e?e:0,null!==(o=null===(s=u.dropShadow)||void 0===s?void 0:s.distance)&&void 0!==o?o:0,null!==(c=null===(l=u.dropShadow)||void 0===l?void 0:l.blur)&&void 0!==c?c:0),{ts:t.ts,pixiText:d}}));n.visible=!1,Zt()(t,le).stage.addChild(n),Zt()(t,de).set(e.id,{container:n,words:a,defStyle:r,maxEffectWidth:i})}))}},{key:"destroy",value:function(){Zt()(this,le).destroy(!0,!0),Zt()(this,de).forEach((function(t){t.container.destroy({children:!0,texture:!0})})),Zt()(this,de).clear()}}]),t}();function he(t,e,n,r,i){var a,o,s,c,l=null!==(a=n.animation)&&void 0!==a?a:{},d=l.in,u=l.out,h=r.map((function(t){return Wt()(Wt()({},t),{},{ts:[(t.ts[0]-n.startTime)/1e6,(t.ts[1]-n.startTime)/1e6]})})),p={x:e.x,y:e.y,w:e.width,h:e.height};null!=d&&re[d.type]&&re[d.type](t,{container:e,words:h,originCtnrRect:p},{duration:(null!==(o=d.duration)&&void 0!==o?o:1e6)/1e6});null!=u&&ie[u.type]&&ie[u.type](t,{container:e,words:h,originCtnrRect:p},{duration:(null!==(s=u.duration)&&void 0!==s?s:1e6)/1e6,delay:(n.endTime-(null!==(c=u.duration)&&void 0!==c?c:1e6))/1e6});var f=n.endTime-n.startTime;t.to({},{duration:f/1e6},0),t.progress(Math.min((i-n.startTime)/f,1))}var pe=n(12027),fe=n.n(pe),me=n(87257),ye=n.n(me),ge=n(8799),we=n.n(ge),xe=n(28633),ve=n.n(xe);function be(t,e){var n=new OffscreenCanvas(1,1).getContext("2d");n.textBaseline="top";var r=e.letterSpacing||0,i=0,a=0,o=e.layers.find((function(t){return"fillText"===t.type})),s=e.layers.find((function(t){return"strokeText"===t.type}));if(n.font=(null==o?void 0:o.font)||(null==s?void 0:s.font)||"24px Arial",0!==r)for(var c=0;c<t.length;c++){var l=n.measureText(t[c]);i+=l.width;var d=l.actualBoundingBoxAscent+l.actualBoundingBoxDescent;a=Math.max(a,d),c<t.length-1&&(i+=r)}else{var u=n.measureText(t);i=u.width,a=u.actualBoundingBoxAscent+u.actualBoundingBoxDescent}var h,p=0,f=0,m=0,y=0,g=0,w=0,x=0,v=0,b=Ut()(e.layers);try{for(b.s();!(h=b.n()).done;){var S=h.value,C=S.x||0,k=S.y||0;if(g=Math.min(g,C),w=Math.min(w,k),x=Math.max(x,C),v=Math.max(v,k),"strokeText"===S.type&&(y=Math.max(y,S.lineWidth)),("fillText"===S.type||"strokeText"===S.type)&&S.shadow){var T=S.shadow.split(" ");if(T.length>=4){var A=ve()(T,3),E=A[0],F=A[1],R=A[2];p=Math.max(p,Math.abs(parseFloat(E))),f=Math.max(f,Math.abs(parseFloat(F))),m=Math.max(m,parseFloat(R))}}}}catch(t){b.e(t)}finally{b.f()}return{textWidth:i,textHeight:a,finalWidth:i+2*Math.max(p+m,y/2)+(x-g),finalHeight:a+2*Math.max(f+m,y/2)+.1*a+(v-w)}}function Se(t,e){return Ce.apply(this,arguments)}function Ce(){return(Ce=s()(a()().mark((function t(e,n){var r,i,o,s,c,l,d,u,h,p,f,m,y,g,w;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=be(e,n),i=r.textWidth,o=r.textHeight,s=r.finalWidth,c=r.finalHeight,l=new OffscreenCanvas(s,c),d=new ee.MxU,t.next=5,d.init({canvas:l,width:s,height:c,backgroundAlpha:0});case 5:u=new ee.W20,d.stage.addChild(u),h=(l.width-i)/2,p=(l.height-o)/2,f=Ut()(n.layers),t.prev=10,f.s();case 12:if((m=f.n()).done){t.next=18;break}return g=m.value,t.next=16,ke(u,e,g,{x:h,y:p,letterSpacing:null!==(y=n.letterSpacing)&&void 0!==y?y:0,layers:n.layers});case 16:t.next=12;break;case 18:t.next=23;break;case 20:t.prev=20,t.t0=t.catch(10),f.e(t.t0);case 23:return t.prev=23,f.f(),t.finish(23);case 26:return d.render(),t.next=29,createImageBitmap(l);case 29:return w=t.sent,d.destroy(!0,!0),t.abrupt("return",w);case 32:case"end":return t.stop()}}),t,null,[[10,20,23,26]])})))).apply(this,arguments)}function ke(t,e,n,r){return Te.apply(this,arguments)}function Te(){return(Te=s()(a()().mark((function t(e,n,r,i){var o,s,c,l,d,u,h,p,f,m,y,g,w,x,v,b,S;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(c=i.x+(null!==(o=r.x)&&void 0!==o?o:0),l=i.y+(null!==(s=r.y)&&void 0!==s?s:0),"img"===r.type){if(d=be(n,{letterSpacing:i.letterSpacing,layers:i.layers}),u=d.textWidth,h=d.textHeight,"stretch"===r.style)(m=ee.jyi.from(r.data)).x=c,m.y=l,m.width=null!==(p=r.w)&&void 0!==p?p:u,m.height=null!==(f=r.h)&&void 0!==f?f:h,e.addChild(m);else if("perChar"===r.style)for(y=u/n.length,g=0;g<n.length;g++)(v=ee.jyi.from(r.data)).x=g*y+c,v.y=l,v.width=null!==(w=r.w)&&void 0!==w?w:y,v.height=null!==(x=r.h)&&void 0!==x?x:h,e.addChild(v)}else"fillText"!==r.type&&"strokeText"!==r.type||(b=Ae(r),(S=new ee.xvT({text:n,style:new ee.pn8(Wt()(Wt()({},b),{},{letterSpacing:i.letterSpacing}))})).x=c,S.y=l,e.addChild(S));case 3:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Ae(t){var e={};if("font"in t){var n=t.font.split(" ");n.length>=2&&(e.fontFamily=n[n.length-1],e.fontSize=parseInt(n[n.length-2]),n.includes("bold")&&(e.fontWeight="bold"),n.includes("italic")&&(e.fontStyle="italic"))}if("fillText"===t.type){if("string"==typeof t.style)if(t.style.startsWith("linear-gradient")){var r=function(t){var e=t.trim().match(/^linear-gradient\s*\(\s*(.+)\s*\)$/);if(!e)return null;var n=e[1].split(",").map((function(t){return t.trim()}));if(n.length<6)return null;try{for(var r=parseFloat(n[0]),i=parseFloat(n[1]),a=parseFloat(n[2]),o=parseFloat(n[3]),s=[],c=4;c<n.length;c++){var l=n[c].trim().match(/^(.+)\s+([0-9.]+)$/);if(l){var d=l[1].trim(),u=parseFloat(l[2]);s.push({color:d,stop:u})}}if(s.length<2)return null;var h=new ee.fH_({type:"linear",start:{x:r,y:i},end:{x:a,y:o}});return s.forEach((function(t){h.addColorStop(t.stop,t.color)})),h}catch(e){return console.warn("Failed to parse linear gradient:",t,e),null}}(t.style);r&&(e.fill=r)}else e.fill={color:t.style}}else"strokeText"===t.type&&(e.stroke={join:"round",cap:"round",width:t.lineWidth},"string"==typeof t.style&&(e.stroke.color=t.style,e.fill=t.style));if("shadow"in t&&t.shadow){var i=t.shadow.split(" ");i.length>=4&&(e.dropShadow={alpha:1,angle:Math.atan2(parseInt(i[1]),parseInt(i[0])),blur:parseInt(i[2]),color:i.slice(3).join(" "),distance:Math.sqrt(Math.pow(parseInt(i[0]),2)+Math.pow(parseInt(i[1]),2))})}return e}O.p8.registerPlugin(te.w),te.w.registerPIXI({Application:ee.MxU,Assets:ee.deM,Container:ee.W20,Sprite:ee.jyi,Text:ee.xvT});var Ee=new WeakMap,Fe=new WeakMap,Re=new WeakMap,Ie=new WeakMap,Me=new WeakMap,Oe=new WeakMap,Pe=new WeakSet,Be=function(){function t(e,n){var r=this;$t()(this,t),ye()(this,Pe),Qt()(this,Ee,{writable:!0,value:void 0}),Qt()(this,Fe,{writable:!0,value:[]}),Qt()(this,Re,{writable:!0,value:{width:0,height:0,duration:0}}),Qt()(this,Ie,{writable:!0,value:void 0}),Qt()(this,Me,{writable:!0,value:void 0}),Qt()(this,Oe,{writable:!0,value:O.p8.timeline()}),Gt()(this,"ready",void 0),Kt()(this,Ee,n),Kt()(this,Fe,e),Kt()(this,Ie,new OffscreenCanvas(n.videoWidth,n.videoHeight)),Kt()(this,Me,new ee.MxU),this.ready=Zt()(this,Me).init({view:Zt()(this,Ie),width:n.videoWidth,height:n.videoHeight,backgroundAlpha:0,preference:"webgl",failIfMajorPerformanceCaveat:!1}).then((function(){return Zt()(r,Re).width=n.videoWidth,Zt()(r,Re).height=n.videoHeight,Zt()(r,Re).duration=e.length>0?Math.max.apply(Math,fe()(e.map((function(t){return t.endTime})))):0,r.meta})).catch((function(t){return console.warn("PIXI Application init failed, falling back to canvas rendering:",t),Zt()(r,Re).width=n.videoWidth,Zt()(r,Re).height=n.videoHeight,Zt()(r,Re).duration=e.length>0?Math.max.apply(Math,fe()(e.map((function(t){return t.endTime})))):0,r.meta}))}var e,n;return Ht()(t,[{key:"meta",get:function(){return Wt()({},Zt()(this,Re))}},{key:"tick",value:(n=s()(a()().mark((function t(e){var n,r,i,o,s,c,l,d,u,h,p,f,m;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=Zt()(this,Fe).filter((function(t){return e>=t.startTime&&e<=t.endTime})),0!==n.length){t.next=3;break}return t.abrupt("return",{state:"done"});case 3:Zt()(this,Me).stage.removeChildren(),Zt()(this,Oe).clear(),r={},i=Ut()(n),t.prev=7,i.s();case 9:if((o=i.n()).done){t.next=36;break}l=o.value,d=new ee.W20,Zt()(this,Me).stage.addChild(d),u=Ut()(l.conf.layers),t.prev=14,u.s();case 16:if((h=u.n()).done){t.next=22;break}return f=h.value,t.next=20,ke(d,l.text,f,{x:0,y:0,letterSpacing:null!==(p=l.conf.letterSpacing)&&void 0!==p?p:0,layers:l.conf.layers});case 20:t.next=16;break;case 22:t.next=27;break;case 24:t.prev=24,t.t0=t.catch(14),u.e(t.t0);case 27:return t.prev=27,u.f(),t.finish(27);case 30:d.x=null!==(s=l.x)&&void 0!==s?s:(Zt()(this,Ie).width-d.width)/2,d.y=null!==(c=l.y)&&void 0!==c?c:(Zt()(this,Ie).height-d.height)/2,r[l.id]=new Ct(d.x,d.y,d.width,d.height),l.conf.animation&&we()(this,Pe,Le).call(this,d,l,e);case 34:t.next=9;break;case 36:t.next=41;break;case 38:t.prev=38,t.t1=t.catch(7),i.e(t.t1);case 41:return t.prev=41,i.f(),t.finish(41);case 44:return Zt()(this,Me).render(),t.next=47,createImageBitmap(Zt()(this,Ie));case 47:return m=t.sent,t.abrupt("return",{state:"success",video:m,contentRects:r});case 49:case"end":return t.stop()}}),t,this,[[7,38,41,44],[14,24,27,30]])}))),function(t){return n.apply(this,arguments)})},{key:"clone",value:(e=s()(a()().mark((function e(){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new t(Zt()(this,Fe),Zt()(this,Ee)));case 1:case"end":return e.stop()}}),e,this)}))),function(){return e.apply(this,arguments)})},{key:"destroy",value:function(){Zt()(this,Oe).kill(),Zt()(this,Me).destroy(!0,!0)}}]),t}();function Le(t,e,n){var r=e.conf.animation;if(r){var i,a,o,s=r.in,c=r.out,l={x:t.x,y:t.y,w:t.width,h:t.height};if(s&&re[s.type])re[s.type](Zt()(this,Oe),{container:t,words:[],originCtnrRect:l},{duration:(null!==(i=s.duration)&&void 0!==i?i:1e6)/1e6});if(c&&ie[c.type])ie[c.type](Zt()(this,Oe),{container:t,words:[],originCtnrRect:l},{duration:(null!==(a=c.duration)&&void 0!==a?a:1e6)/1e6,delay:(e.endTime-(null!==(o=c.duration)&&void 0!==o?o:1e6))/1e6});var d=e.endTime-e.startTime;Zt()(this,Oe).to({},{duration:d/1e6},0),Zt()(this,Oe).progress(Math.min((n-e.startTime)/d,1))}}var _e=function(t){for(var e=atob(t),n=new Uint8Array(e.length),r=0;r<e.length;r++)n[r]=e.charCodeAt(r);return n.buffer},We=function(t){for(var e=atob(t),n=new Uint8Array(e.length),r=0;r<e.length;r++)n[r]=e.charCodeAt(r);return(new TextDecoder).decode(n)},Ve=function(t){var e=t.replace(/-/g,"+").replace(/_/g,"/"),n=e.length%4;return 2===n?e+="==":3===n?e+="=":0!==n&&(e+="==="),e};function ze(t){return De.apply(this,arguments)}function De(){return(De=s()(a()().mark((function t(e){var n,r;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.replace(/-----BEGIN PUBLIC KEY-----/,"").replace(/-----END PUBLIC KEY-----/,"").replace(/\s+/g,""),r=_e(n),t.abrupt("return",crypto.subtle.importKey("spki",r,{name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"},!1,["verify"]));case 3:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Ue(t,e,n){return Ne.apply(this,arguments)}function Ne(){return Ne=s()(a()().mark((function t(e,n,r){var i,o,s,c,l;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,ze(e);case 2:return i=t.sent,o=new TextEncoder,s=o.encode(n),c=_e(Ve(r)),t.next=8,crypto.subtle.verify("RSASSA-PKCS1-v1_5",i,c,s);case 8:return l=t.sent,t.abrupt("return",l);case 10:case"end":return t.stop()}}),t)}))),Ne.apply(this,arguments)}function $e(t,e){return je.apply(this,arguments)}function je(){return je=s()(a()().mark((function t(e,n){var r,i,o,s,c,l,d;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!((r=n.indexOf("."))<=0)){t.next=3;break}return t.abrupt("return",{ok:!1});case 3:i=n.slice(0,r),o=n.slice(r+1),s=Ve(i),c=Ve(o),t.prev=7,l=We(s),t.next=14;break;case 11:return t.prev=11,t.t0=t.catch(7),t.abrupt("return",{ok:!1});case 14:return t.next=16,Ue(e,l,c);case 16:if(t.sent){t.next=19;break}return t.abrupt("return",{ok:!1});case 19:return t.prev=19,d=JSON.parse(l),t.abrupt("return",{ok:!0,payload:d});case 24:return t.prev=24,t.t1=t.catch(19),t.abrupt("return",{ok:!1});case 27:case"end":return t.stop()}}),t,null,[[7,11],[19,24]])}))),je.apply(this,arguments)}var He="\n-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvGkH/R1YaaYnCtqLxYF1\nqw+X6JhrBWonDhUrxdX+nMK7po4ZALbiAWoxSnDl1hcGJ6y8O043K1ivQEjqSAy+\nTf3BBH8pI1Y1PmuIRhym0T5O+FKSLjAGDuDf4UzwFqtxiNFTytKIpsvoRxUQdgqI\neikrEnBwng1UNiIQRLZ0QvBDJvcwntICnHUmEg8ECP88LKheroTO5gld5Vd2vrqu\nTl47QBdW5k3bLJMZ2jE6VMq7vUvM9thLzCWeb4qYxL9Vn8Q/k1TQeTsJ6WjWsOnV\nmh0GEqmn97+DfQ/UnQjKbl17u5Q8r8344xsKDoN+MdLpuxG8Q72L4MToIkkgrXWA\nCQIDAQAB\n-----END PUBLIC KEY-----\n",Ye=function(t,e){var n=function(t){return function(t){return t.split(":")[0].toLowerCase()}(t).split(".").filter(Boolean)},r=n(t),i=n(e);if(0===i.length)return!1;if(r.length<i.length)return!1;for(var a=1;a<=i.length;a++)if(r[r.length-a]!==i[i.length-a])return!1;return!0};function Ge(t){return Xe.apply(this,arguments)}function Xe(){return(Xe=s()(a()().mark((function t(e){var n;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,$e(He,e);case 2:if((n=t.sent).ok&&n.payload){t.next=5;break}return t.abrupt("return",!1);case 5:if(Ye(location.host,n.payload.host)){t.next=7;break}return t.abrupt("return",!1);case 7:if("number"==typeof n.payload.exp){t.next=9;break}return t.abrupt("return",!1);case 9:if(!(Math.floor(Date.now()/1e3)>n.payload.exp)){t.next=12;break}return t.abrupt("return",!1);case 12:return t.abrupt("return",!0);case 13:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Qe(t,e){var n=ve()(e,2),r=n[0],i=n[1];r.setAnimation({from:{opacity:1},to:{opacity:0}},{duration:t,iterCount:1,delay:r.time.duration-t}),i.time.offset=r.time.offset+t-t,r.zIndex=i.zIndex+1}function Je(t,e){var n=ve()(e,2),r=n[0],i=n[1],a=t/2;qe(r.getClip(),r.time.duration-a,a,Ze({width:r.rect.w,height:r.rect.h,color:{from:{r:0,g:0,b:0,a:0},to:{r:0,g:0,b:0,a:255}}})),qe(i.getClip(),0,a,Ze({width:i.rect.w,height:i.rect.h,color:{from:{r:0,g:0,b:0,a:255},to:{r:0,g:0,b:0,a:0}}}))}function Ke(t,e){var n=ve()(e,2),r=n[0],i=n[1],a=t/2;qe(r.getClip(),r.time.duration-a,a,Ze({width:r.rect.w,height:r.rect.h,color:{from:{r:255,g:255,b:255,a:0},to:{r:255,g:255,b:255,a:255}}})),qe(i.getClip(),0,a,Ze({width:i.rect.w,height:i.rect.h,color:{from:{r:255,g:255,b:255,a:255},to:{r:255,g:255,b:255,a:0}}}))}function qe(t,e,n,r){if(t instanceof J){e<0&&(e=0);var i=t.tickInterceptor;t.tickInterceptor=function(){var t=s()(a()().mark((function t(o,s){var c,l;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,i(o,s);case 2:if(!(null==(c=t.sent).video||o<e)){t.next=5;break}return t.abrupt("return",c);case 5:return l=r(c.video,(o-e)/n),c.video.close(),t.abrupt("return",Wt()(Wt()({},c),{},{video:l}));case 8:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}()}}function Ze(t){var e=t.width,n=t.height,r=new OffscreenCanvas(e,n),i=r.getContext("2d"),a=t.color,o=a.from,s=a.to;return function(t,a){var c;if(a<0||a>1)return new VideoFrame(t);i.globalAlpha=1,i.clearRect(0,0,e,n),i.drawImage(t,0,0,e,n);var l=function(t){return{r:o.r+(s.r-o.r)*t,g:o.g+(s.g-o.g)*t,b:o.b+(s.b-o.b)*t,a:o.a+(s.a-o.a)*t}}(a),d=l.r,u=l.g,h=l.b,p=l.a;return i.fillStyle="rgb(".concat(d," ").concat(u," ").concat(h,")"),i.globalAlpha=p/255,i.fillRect(0,0,e,n),new VideoFrame(r,{timestamp:t.timestamp,duration:null!==(c=t.duration)&&void 0!==c?c:0})}}function tn(t,e,n){var r=ve()(n,2),i=r[0],a=r[1],o={left:{pre:{from:{x:i.rect.x},to:{x:-1*i.rect.w}},post:{from:{x:a.rect.x+a.rect.w},to:{x:a.rect.x}}},right:{pre:{from:{x:i.rect.x},to:{x:i.rect.w}},post:{from:{x:a.rect.x-a.rect.w},to:{x:a.rect.x}}},up:{pre:{from:{y:i.rect.y},to:{y:-1*i.rect.h}},post:{from:{y:a.rect.y+a.rect.h},to:{y:a.rect.y}}},down:{pre:{from:{y:i.rect.y},to:{y:i.rect.h}},post:{from:{y:a.rect.y-a.rect.h},to:{y:a.rect.y}}}};i.setAnimation(o[t].pre,{duration:e,iterCount:1,delay:i.time.duration-e}),a.setAnimation(o[t].post,{duration:e,iterCount:1,delay:0}),a.time.offset=i.time.offset+i.time.duration-e}function en(t,e,n){var r=ve()(n,2),i=r[0],a=r[1],o={left:{from:{x:a.rect.x+a.rect.w},to:{x:a.rect.x}},right:{from:{x:a.rect.x-a.rect.w},to:{x:a.rect.x}},up:{from:{y:a.rect.y+a.rect.h},to:{y:a.rect.y}},down:{from:{y:a.rect.y-a.rect.h},to:{y:a.rect.y}}};a.setAnimation(o[t],{duration:e,iterCount:1,delay:0}),a.time.offset=i.time.offset+i.time.duration-e}function nn(t,e,n){return rn.apply(this,arguments)}function rn(){return(rn=s()(a()().mark((function t(e,n,r){return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Promise.all(r.map((function(t){return t.ready})));case 2:t.t0=e,t.next="fade"===t.t0?5:"fadeblack"===t.t0?7:"fadewhite"===t.t0?9:"wipeleft"===t.t0?11:"wiperight"===t.t0?13:"wipeup"===t.t0?15:"wipedown"===t.t0?17:"slideleft"===t.t0?19:"slideright"===t.t0?21:"slideup"===t.t0?23:"slidedown"===t.t0?25:27;break;case 5:return Qe(n,r),t.abrupt("return");case 7:return Je(n,r),t.abrupt("return");case 9:return Ke(n,r),t.abrupt("return");case 11:return en("left",n,r),t.abrupt("return");case 13:return en("right",n,r),t.abrupt("return");case 15:return en("up",n,r),t.abrupt("return");case 17:return en("down",n,r),t.abrupt("return");case 19:return tn("left",n,r),t.abrupt("return");case 21:return tn("right",n,r),t.abrupt("return");case 23:return tn("up",n,r),t.abrupt("return");case 25:return tn("down",n,r),t.abrupt("return");case 27:throw Error("Invalid transition name");case 28:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var an=n(89517),on={color:"white",fontWeight:"normal",fontStyle:"normal",fontSize:"24px",fontFamily:"Arial"},sn=1,cn=10,ln=100,dn=["color","fontWeight","fontStyle","fontSize","fontFamily"];function un(t,e,n,r){function i(t,e,n,r,i,a,o){var s=e.width,c=e.height,l=Math.min(o,s/3),d=Math.min(o,c/3),u=Math.min(o,i/3),h=Math.min(o,a/3);t.drawImage(e,0,0,l,d,n,r,u,h),t.drawImage(e,s-l,0,l,d,n+i-u,r,u,h),t.drawImage(e,0,c-d,l,d,n,r+a-h,u,h),t.drawImage(e,s-l,c-d,l,d,n+i-u,r+a-h,u,h),t.drawImage(e,l,0,s-2*l,d,n+u,r,i-2*u,h),t.drawImage(e,l,c-d,s-2*l,d,n+u,r+a-h,i-2*u,h),t.drawImage(e,0,d,l,c-2*d,n,r+h,u,a-2*h),t.drawImage(e,s-l,d,l,c-2*d,n+i-u,r+h,u,a-2*h),t.drawImage(e,l,d,s-2*l,c-2*d,n+u,r+h,i-2*u,a-2*h)}t.tree&&t.tree.children&&function t(e,n,a){var o,s=n,c=Ut()(e);try{for(c.s();!(o=c.n()).done;){var l=o.value;if(r.save(),l.computedStyle){if("text"===l.type){var d=l.computedStyle,u=d.fontSize,h=d.fontWeight,p=d.fontStyle,f=d.fontFamily,m=d.color;r.font="".concat(p," ").concat(h," ").concat(u," ").concat(f),m&&(r.fillStyle=m);var y=r.measureText(l.value).width;r.fillText(l.value,s,a+.2*parseFloat(null!=u?u:"0")),s+=y}else if("object"===l.type){var g=l.computedStyle,w=g.width,x=g.height,v=g.borderRadius,b=g.paddingLeft,S=g.paddingTop,C=g.backgroundColor,k=parseFloat(x||"0"),T=parseFloat(v||"0"),A=parseFloat(b||"0"),E=parseFloat(S||"0"),F=parseFloat(w||"0");C&&(r.fillStyle=C,T>0?(r.beginPath(),r.roundRect(s,a,F,k,T),r.fill()):r.fillRect(s,a,F,k));var R=l;"object"===l.type&&R.bgImg&&i(r,R.bgImg,s,a,F,k,10),s=t(l.children,s+A,a+E)}r.restore()}}}catch(t){c.e(t)}finally{c.f()}return s}([t.tree],e,n)}var hn=m.create("[@webav WebVTTClip]"),pn=new WeakMap,fn=new WeakMap,mn=new WeakMap,yn=new WeakMap,gn=new WeakMap,wn=new WeakMap,xn=new WeakMap,vn=function(){function t(e,n){var r=this;$t()(this,t),Qt()(this,pn,{writable:!0,value:void 0}),Qt()(this,fn,{writable:!0,value:void 0}),Gt()(this,"ready",void 0),Qt()(this,mn,{writable:!0,value:{duration:0,width:0,height:0}}),Qt()(this,yn,{writable:!0,value:void 0}),Qt()(this,gn,{writable:!0,value:void 0}),Qt()(this,wn,{writable:!0,value:void 0}),Qt()(this,xn,{writable:!0,value:[]}),Kt()(this,yn,e),Kt()(this,gn,n),Kt()(this,pn,new OffscreenCanvas(n.videoWidth,n.videoHeight)),Kt()(this,fn,Zt()(this,pn).getContext("2d")),Zt()(this,fn).textBaseline="top";var i=new an.WebVTTParser;Kt()(this,wn,i.parse(e,"metadata")),Zt()(this,wn).cues.forEach((function(t){t.tree.type="object",t.tree.name="cue",t.tree.classes=[],t.tree.computedStyle={},t.startTime*=1e6,t.endTime*=1e6})),hn.debug("vtt parsedData",Zt()(this,wn)),Kt()(this,xn,function(t){if(!t||0===t.length)return[];var e,n=[],r=Ut()(t);try{for(r.s();!(e=r.n()).done;){var i=e.value.match(/([^{]+)\s*{\s*([^}]+)\s*}/g);if(i){var a,o=Ut()(i);try{for(o.s();!(a=o.n()).done;){var s=a.value.match(/([^{]+)\s*{\s*([^}]+)\s*}/)||[],c=ve()(s,3),l=c[1],d=c[2];if(l&&d){var u=l.trim().replace(/^video::cue/,"::cue"),h=sn;u.includes(".")?h=ln:u.includes("(")&&u.includes(")")&&(h=cn);var p={},f=d.match(/([^:;]+)\s*:\s*([^;]+)/g);if(f){var m,y=Ut()(f);try{for(y.s();!(m=y.n()).done;){var g=m.value.match(/([^:]+)\s*:\s*([^;]+)/)||[],w=ve()(g,3),x=w[1],v=w[2];if(x&&v){var b=x.trim().replace(/-([a-z])/g,(function(t,e){return e.toUpperCase()}));if("padding"===b){var S=v.trim().split(/\s+/).map((function(t){return t.trim()}));switch(S.length){case 1:p.paddingTop=S[0],p.paddingRight=S[0],p.paddingBottom=S[0],p.paddingLeft=S[0];break;case 2:p.paddingTop=S[0],p.paddingBottom=S[0],p.paddingRight=S[1],p.paddingLeft=S[1];break;case 3:p.paddingTop=S[0],p.paddingRight=S[1],p.paddingLeft=S[1],p.paddingBottom=S[2];break;case 4:p.paddingTop=S[0],p.paddingRight=S[1],p.paddingBottom=S[2],p.paddingLeft=S[3]}}else if("backgroundImage"===b){var C=v.trim().match(/url\(['"]?(.*?)['"]?\)/);C&&C[1]?p[b]=C[1].trim():p[b]=v.trim()}else p[b]=v.trim()}}}catch(t){y.e(t)}finally{y.f()}}n.push({selector:u,specificity:h,properties:p})}}}catch(t){o.e(t)}finally{o.f()}}}}catch(t){r.e(t)}finally{r.f()}return n}(Zt()(this,wn).styles)),Kt()(this,mn,{width:n.videoWidth,height:n.videoHeight,duration:Zt()(this,wn).cues[Zt()(this,wn).cues.length-1].endTime}),this.ready=function(t,e){return bn.apply(this,arguments)}(Zt()(this,wn).cues,Zt()(this,xn)).then((function(){return Promise.resolve(r.meta)}))}var e,n;return Ht()(t,[{key:"meta",get:function(){return Wt()({},Zt()(this,mn))}},{key:"tick",value:(n=s()(a()().mark((function t(e){var n,r,i,o,s,c,l,d,u,h,p,f,m;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(Zt()(this,fn).clearRect(0,0,Zt()(this,mn).width,Zt()(this,mn).height),!(e>Zt()(this,mn).duration)){t.next=6;break}return t.next=4,createImageBitmap(Zt()(this,pn));case 4:return t.t0=t.sent,t.abrupt("return",{state:"done",video:t.t0});case 6:if(n=Zt()(this,wn).cues.filter((function(t){return e>=t.startTime&&e<=t.endTime})),r=Zt()(this,mn),i=r.width,o=r.height,s=new Ct(i,o,0,0),n.length>0){c=Ut()(n);try{for(c.s();!(l=c.n()).done;)d=l.value,u=void 0,u="auto"===d.linePosition?.8*o:o*d.linePosition/100,h=d.tree.computedStyle,p=h.width,f=h.height,m=void 0,m="auto"===d.textPosition?i/2-parseFloat(p)/2:i*d.textPosition/100,s.x=Math.min(s.x,m)-10,s.y=Math.min(s.y,u)-10,s.w=Math.max(s.w,parseFloat(p))+20,s.h=Math.max(s.h,parseFloat(f))+20,un(d,m,u,Zt()(this,fn))}catch(t){c.e(t)}finally{c.f()}}return t.next=12,createImageBitmap(Zt()(this,pn));case 12:return t.t1=t.sent,t.t2={0:s},t.abrupt("return",{state:"success",video:t.t1,contentRects:t.t2});case 15:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"clone",value:(e=s()(a()().mark((function e(){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new t(Zt()(this,yn),Wt()({},Zt()(this,gn))));case 1:case"end":return e.stop()}}),e,this)}))),function(){return e.apply(this,arguments)})},{key:"destroy",value:function(){}}]),t}();function bn(){return(bn=s()(a()().mark((function t(e,n){var r,i,o,s,c;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=new OffscreenCanvas(900,500),i=r.getContext("2d"),o=Ut()(e),t.prev=3,o.s();case 5:if((s=o.n()).done){t.next=12;break}return c=s.value,t.next=9,Sn([c.tree],n);case 9:kn(c.tree,i);case 10:t.next=5;break;case 12:t.next=17;break;case 14:t.prev=14,t.t0=t.catch(3),o.e(t.t0);case 17:return t.prev=17,o.f(),t.finish(17);case 20:case"end":return t.stop()}}),t,null,[[3,14,17,20]])})))).apply(this,arguments)}function Sn(t,e,n){return Cn.apply(this,arguments)}function Cn(){return(Cn=s()(a()().mark((function t(e,n,r){var i,o,s,c,l,d,u,h,p,f,m,y,g,w,x,v,b,S,C,k,T,A,E,F,R,I;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:i=Ut()(e),t.prev=1,i.s();case 3:if((o=i.n()).done){t.next=82;break}(s=o.value).computedStyle={},"object"===s.type&&"cue"===s.name&&Object.assign(s.computedStyle,on),c={default:[],tag:[],class:[]},l=Ut()(n),t.prev=9,l.s();case 11:if((d=l.n()).done){t.next=42;break}if(u=d.value,"object"!==s.type||"cue"!==s.name||"::cue"!==u.selector){t.next=17;break}c.default.push(u),t.next=40;break;case 17:if("object"!==s.type||u.selector!=="::cue(".concat(s.name,")")){t.next=21;break}c.tag.push(u),t.next=40;break;case 21:if(!("object"===s.type&&s.classes&&s.classes.length>0)){t.next=40;break}h=Ut()(s.classes),t.prev=23,h.s();case 25:if((p=h.n()).done){t.next=32;break}if(f=p.value,u.selector!=="::cue(.".concat(f,")")){t.next=30;break}return c.class.push(u),t.abrupt("break",32);case 30:t.next=25;break;case 32:t.next=37;break;case 34:t.prev=34,t.t0=t.catch(23),h.e(t.t0);case 37:return t.prev=37,h.f(),t.finish(37);case 40:t.next=11;break;case 42:t.next=47;break;case 44:t.prev=44,t.t1=t.catch(9),l.e(t.t1);case 47:return t.prev=47,l.f(),t.finish(47);case 50:m=Ut()(c.default);try{for(m.s();!(y=m.n()).done;)g=y.value,Object.assign(s.computedStyle,g.properties)}catch(t){m.e(t)}finally{m.f()}if(r){w=Ut()(dn);try{for(w.s();!(x=w.n()).done;)v=x.value,void 0!==r[b=v]&&(s.computedStyle[b]=r[b])}catch(t){w.e(t)}finally{w.f()}}S=Ut()(c.tag);try{for(S.s();!(C=S.n()).done;)k=C.value,Object.assign(s.computedStyle,k.properties)}catch(t){S.e(t)}finally{S.f()}T=Ut()(c.class);try{for(T.s();!(A=T.n()).done;)E=A.value,Object.assign(s.computedStyle,E.properties)}catch(t){T.e(t)}finally{T.f()}if("object"!==s.type){t.next=79;break}if("cue"!==s.name){t.next=78;break}if(F=s,!s.computedStyle.backgroundImage||F.bgImg){t.next=78;break}return t.prev=61,t.next=64,fetch(s.computedStyle.backgroundImage);case 64:return R=t.sent,t.t2=createImageBitmap,t.next=68,R.blob();case 68:return t.t3=t.sent,t.next=71,(0,t.t2)(t.t3);case 71:I=t.sent,F.bgImg=I,t.next=78;break;case 75:t.prev=75,t.t4=t.catch(61),hn.warn("backgroundImage load error",t.t4);case 78:"b"===s.name&&"normal"===s.computedStyle.fontWeight?s.computedStyle.fontWeight="bold":"i"===s.name&&"normal"===s.computedStyle.fontStyle?s.computedStyle.fontStyle="italic":"v"===s.name&&s.computedStyle.color===on.color&&(s.computedStyle.color="yellow");case 79:"object"===s.type&&s.children.length>0&&Sn(s.children,n,s.computedStyle);case 80:t.next=3;break;case 82:t.next=87;break;case 84:t.prev=84,t.t5=t.catch(1),i.e(t.t5);case 87:return t.prev=87,i.f(),t.finish(87);case 90:case"end":return t.stop()}}),t,null,[[1,84,87,90],[9,44,47,50],[23,34,37,40],[61,75]])})))).apply(this,arguments)}function kn(t,e){if(!t.computedStyle)throw new Error("node.computedStyle is undefined");var n=t.computedStyle;if(n.width&&n.height)return{width:n.width,height:n.height};var r=n.fontStyle,i=n.fontWeight,a=n.fontSize,o=n.fontFamily,s=n.paddingLeft,c=n.paddingRight,l=n.paddingTop,d=n.paddingBottom;if(e.font="".concat(r," ").concat(i," ").concat(a," ").concat(o),"text"===t.type){var u=e.measureText(t.value),h=parseInt(a||"24");return n.width="".concat(u.width,"px"),n.height="".concat(1.2*h,"px"),{width:n.width,height:n.height}}var p,f=0,m=0,y=Ut()(t.children);try{for(y.s();!(p=y.n()).done;){var g=kn(p.value,e),w=g.width,x=g.height;f+=parseFloat(w),m=Math.max(m,parseFloat(x))}}catch(t){y.e(t)}finally{y.f()}return n.width=f+parseFloat(null!=s?s:"0")+parseFloat(null!=c?c:"0")+"px",n.height=m+parseFloat(null!=l?l:"0")+parseFloat(null!=d?d:"0")+"px",{width:n.width,height:n.height}}const Tn=["t","b","l","r","lt","lb","rt","rb","rotate"];function An(t){return document.createElement(t)}const En=new WeakMap;function Fn(t,e){if(En.has(t))return En.get(t)(e);let n=10;function r(t){const{w:e,h:r}=t,i=n,a=i/2,o=e/2,s=r/2,c=1.5*i,l=c/2;return{...t.fixedAspectRatio?{}:{t:new Ct(-a,-s-a,i,i,t),b:new Ct(-a,s-a,i,i,t),l:new Ct(-o-a,-a,i,i,t),r:new Ct(o-a,-a,i,i,t)},lt:new Ct(-o-a,-s-a,i,i,t),lb:new Ct(-o-a,s-a,i,i,t),rt:new Ct(o-a,-s-a,i,i,t),rb:new Ct(o-a,s-a,i,i,t),rotate:new Ct(-l,-s-2*i-l,c,c,t)}}return new ResizeObserver((e=>{const r=e[0];null!=r&&(n=10/(r.contentRect.width/t.width))})).observe(t),En.set(t,r),r(e)}const Rn=new WeakMap;function In(t){if(Rn.has(t))return Rn.get(t);const e={w:t.clientWidth/t.width,h:t.clientHeight/t.height};return new ResizeObserver((()=>{e.w=t.clientWidth/t.width,e.h=t.clientHeight/t.height})).observe(t),Rn.set(t,e),e}var Mn=(t=>(t.ActiveSpriteChange="activeSpriteChange",t.AddSprite="addSprite",t))(Mn||{});class On{#e=[];#t=null;#r=new l;on=this.#r.on;get activeSprite(){return this.#t}set activeSprite(t){t!==this.#t&&(this.#t=t,this.#r.emit("activeSpriteChange",t))}activeSpriteByCoord(t,e){this.activeSprite=this.getSprites().reverse().find((n=>n.visible&&n.rect.checkHit(t,e)))??null}async addSprite(t){await t.ready,this.#e.push(t),this.#e=this.#e.sort(((t,e)=>t.zIndex-e.zIndex)),t.on("propsChange",(t=>{null!=t.zIndex&&(this.#e=this.#e.sort(((t,e)=>t.zIndex-e.zIndex)))})),this.#r.emit("addSprite",t)}removeSprite(t){this.#t===t&&(this.activeSprite=null),this.#e=this.#e.filter((e=>e!==t)),t.destroy()}getSprites(t={time:!0}){return this.#e.filter((e=>e.visible&&(!t.time||this.#o>=e.time.offset&&this.#o<=e.time.offset+e.time.duration)))}#o=0;updateRenderTime(t){this.#o=t;const e=this.activeSprite;null!=e&&(t<e.time.offset||t>e.time.offset+e.time.duration)&&(this.activeSprite=null)}destroy(){this.#r.destroy(),this.#e.forEach((t=>t.destroy())),this.#e=[]}}function Pn(t,e,n){const r=In(e),i=new ResizeObserver((()=>{null!=n.activeSprite&&Bn(n.activeSprite,e,o,s)}));i.observe(e);let a=()=>{};const{rectEl:o,ctrlsEl:s}=function(t){const e=An("div");e.classList.add("sprite-rect"),e.style.cssText="\n    position: absolute;\n    z-index: 3;\n    pointer-events: auto;\n    border: 1px solid #eee;\n    box-sizing: border-box;\n    display: none;\n    cursor: move;\n  ";const n=Object.fromEntries(Tn.map((t=>{const e=An("div");return e.classList.add(`ctrl-key-${t}`),e.style.cssText=`\n        display: none;\n        position: absolute;\n        border: 1px solid #3ee; border-radius: 50%;\n        box-sizing: border-box;\n        background-color: #fff;\n        pointer-events: auto;\n        cursor: ${"rotate"===t?"crosshair":"default"};\n        user-select: none;\n      `,[t,e]})));return Object.values(n).forEach((t=>e.appendChild(t))),t.appendChild(e),{rectEl:e,ctrlsEl:n}}(t);o.addEventListener("pointerdown",(t=>{if(Object.values(s).includes(t.target))return;const i=e.getBoundingClientRect(),a=(t.clientX-i.left)/r.w,o=(t.clientY-i.top)/r.h;n.activeSpriteByCoord(a,o)}));const c=n.on(Mn.ActiveSpriteChange,(t=>{a(),null!=t?(Bn(t,e,o,s),a=t.on("propsChange",(()=>{Bn(t,e,o,s)})),o.style.display=""):o.style.display="none"}));return()=>{i.disconnect(),c(),o.remove(),a()}}function Bn(t,e,n,r){const i=In(e),{x:a,y:o,w:s,h:c,angle:l}=t.rect;Object.assign(n.style,{left:a*i.w+"px",top:o*i.h+"px",width:s*i.w+"px",height:c*i.h+"px",rotate:`${l}rad`}),Object.entries(Fn(e,t.rect)).forEach((([t,{x:e,y:n,w:a,h:o}])=>{Object.assign(r[t].style,{display:"block",left:"50%",top:"50%",width:a*i.w+"px",height:o*i.h+"px",transform:`translate(${e*i.w}px, ${n*i.h}px)`})}))}function Ln(t,e,n){let r=0,i=0,a=null;const o=function(t,e){const n="display: none; position: absolute;",r={w:0,h:0,x:0,y:0},i={vertMiddle:{...r,h:100,x:50,ref:{prop:"x",val:({w:e})=>(t.width-e)/2}},horMiddle:{...r,w:100,y:50,ref:{prop:"y",val:({h:e})=>(t.height-e)/2}},top:{...r,w:100,ref:{prop:"y",val:()=>0}},bottom:{...r,w:100,y:100,ref:{prop:"y",val:({h:e})=>t.height-e}},left:{...r,h:100,ref:{prop:"x",val:()=>0}},right:{...r,h:100,x:100,ref:{prop:"x",val:({w:e})=>t.width-e}}},a=An("div");a.style.cssText="\n    position: absolute;\n    z-index: 4;\n    top: 0; left: 0;\n    width: 100%; height: 100%;\n    pointer-events: none;\n    box-sizing: border-box;\n  ";const o=Object.fromEntries(Object.entries(i).map((([t,{w:e,h:r,x:i,y:o}])=>{const s=An("div");return s.style.cssText=`\n        ${n}\n        border-${e>0?"top":"left"}: 1px solid #3ee;\n        top: ${o}%; left: ${i}%;\n        ${100===i?"margin-left: -1px":""};\n        ${100===o?"margin-top: -1px":""};\n        width: ${e}%; height: ${r}%;\n      `,a.appendChild(s),[t,s]})));e.appendChild(a);const s=6/(900/t.width);return{magneticEffect(t,e,n){const r={x:t,y:e},a={x:s,y:s},c={x:"",y:""};Object.values(o).forEach((t=>t.style.display="none"));for(const o in i){const{prop:l,val:d}=i[o].ref,u=d(n),h=Math.abs(("x"===l?t:e)-u);h<=s&&h<a[l]&&(a[l]=h,r[l]=u,c[l]=o)}return c.x&&(o[c.x].style.display="block"),c.y&&(o[c.y].style.display="block"),r},hide(){Object.values(o).forEach((t=>t.style.display="none"))},destroy(){a.remove()}}}(t,n),s=n.querySelector(".sprite-rect");if(!s)throw Error("sprite-rect DOM Node not found");const c=t=>{if(0!==t.button||null==e.activeSprite)return;const n=e.activeSprite,{clientX:s,clientY:c}=t;a=n.rect.clone(),o.magneticEffect(n.rect.x,n.rect.y,n.rect),r=s,i=c,window.addEventListener("pointermove",d),window.addEventListener("pointerup",u),t.stopPropagation()},l=In(t),d=n=>{if(null==e.activeSprite||null==a)return;const{clientX:s,clientY:c}=n;let d=a.x+(s-r)/l.w,u=a.y+(c-i)/l.h;Vn(e.activeSprite.rect,t,o.magneticEffect(d,u,e.activeSprite.rect))},u=()=>{o.hide(),window.removeEventListener("pointermove",d),window.removeEventListener("pointerup",u)};s.addEventListener("pointerdown",c),t.addEventListener("pointerdown",c);const h=function(t,e,n){const r=Array.from(e.children),i=In(t);r.forEach(((e,r)=>{const a=Tn[r];e.addEventListener("pointerdown",(e=>{if(0!==e.button||null==n.activeSprite)return;const{clientX:r,clientY:o}=e;"rotate"===a?function(t,e){const n=({clientX:n,clientY:r})=>{const i=n-e.x,a=r-e.y,o=Math.atan2(a,i)+Math.PI/2;t.angle=o},r=()=>{window.removeEventListener("pointermove",n),window.removeEventListener("pointerup",r)};window.addEventListener("pointermove",n),window.addEventListener("pointerup",r)}(n.activeSprite.rect,function(t,e,n){const r=t.x*e.w,i=t.y*e.h,{left:a,top:o}=n.getBoundingClientRect();return{x:r+a,y:i+o}}(n.activeSprite.rect.center,i,t)):function({sprRect:t,startX:e,startY:n,ctrlKey:r,cvsRatio:i,cvsEl:a}){const o=t.clone(),s=s=>{const{clientX:c,clientY:l}=s,d=(c-e)/i.w,u=(l-n)/i.h,h=1===r.length?_n:Wn,{x:p,y:f,w:m,h:y}=o,g=Math.atan2(y,m),{incW:w,incH:x,incS:v,rotateAngle:b}=h({deltaX:d,deltaY:u,angle:t.angle,ctrlKey:r,diagonalAngle:g}),S=10;let C=m,k=y,T=o.fixedScaleCenter?2*w:w,A=o.fixedScaleCenter?2*x:x,E=v;const F=Math.sqrt(y**2+m**2),R=Math.sqrt((S*(y/m))**2+S**2);switch(r){case"l":C=Math.max(m+T,S),E=Math.min(v,m-S);break;case"r":C=Math.max(m+T,S),E=Math.max(v,S-m);break;case"b":k=Math.max(y+A,S),E=Math.min(v,y-S);break;case"t":k=Math.max(y+A,S),E=Math.max(v,S-y);break;case"lt":case"lb":C=Math.max(m+T,S),k=C===S?y/m*C:y+A,E=Math.min(v,F-R);break;case"rt":case"rb":C=Math.max(m+T,S),k=C===S?y/m*C:y+A,E=Math.max(v,R-F)}let I=p,M=f;if(o.fixedScaleCenter)I=p+m/2-C/2,M=f+y/2-k/2;else{I=E/2*Math.cos(b)+p+m/2-C/2,M=E/2*Math.sin(b)+f+y/2-k/2}Vn(t,a,{x:I,y:M,w:C,h:k})},c=()=>{window.removeEventListener("pointermove",s),window.removeEventListener("pointerup",c)};window.addEventListener("pointermove",s),window.addEventListener("pointerup",c)}({sprRect:n.activeSprite.rect,ctrlKey:a,startX:r,startY:o,cvsRatio:i,cvsEl:t}),e.stopPropagation()}))})),r[Tn.indexOf("rotate")].style.cursor="crosshair";const a=["ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize"],o={t:0,rt:1,r:2,rb:3,b:4,lb:5,l:6,lt:7};let s=()=>{};const c=n.on(Mn.ActiveSpriteChange,(t=>{if(s(),null==t)return;const e=function(t,e){let n=0;return function(...r){0!==n&&clearTimeout(n),n=setTimeout((()=>{t.apply(this,r)}),e)}}((function(){const{angle:e}=t.rect,n=e<0?e+2*Math.PI:e;r.forEach(((t,e)=>{const r=Tn[e];if("rotate"===r)return;const i=(o[r]+Math.floor((n+Math.PI/8)/(Math.PI/4)))%8;t.style.cursor=a[i]}))}),300);s=t.on("propsChange",(t=>{null!=t.rect?.angle&&e()})),e()}));return()=>{s(),c()}}(t,s,e);return()=>{o.destroy(),u(),s.removeEventListener("pointerdown",c),t.removeEventListener("pointerdown",c),h()}}function _n({deltaX:t,deltaY:e,angle:n,ctrlKey:r}){let i=0,a=0,o=0,s=n;return"l"===r||"r"===r?(i=t*Math.cos(n)+e*Math.sin(n),a=i*("l"===r?-1:1)):("t"===r||"b"===r)&&(s=n-Math.PI/2,i=t*Math.cos(s)+e*Math.sin(s),o=i*("b"===r?-1:1)),{incW:a,incH:o,incS:i,rotateAngle:s}}function Wn({deltaX:t,deltaY:e,angle:n,ctrlKey:r,diagonalAngle:i}){const a=("lt"===r||"rb"===r?1:-1)*i+n,o=t*Math.cos(a)+e*Math.sin(a),s="lt"===r||"lb"===r?-1:1;return{incW:o*Math.cos(i)*s,incH:o*Math.sin(i)*s,incS:o,rotateAngle:a}}function Vn(t,e,n){const r={x:t.x,y:t.y,w:t.w,h:t.h,...n},i=.05*e.width,a=.05*e.height;r.x<-r.w+i?r.x=-r.w+i:r.x>e.width-i&&(r.x=e.width-i),r.y<-r.h+a?r.y=-r.h+a:r.y>e.height-a&&(r.y=e.height-a),t.x=r.x,t.y=r.y,t.w=r.w,t.h=r.h}const zn=48e3;class Dn{#e;#t;#r;#o=!1;#p=[];#l;#s=new l;on=this.#s.on;#y;constructor(t,e){this.#y=e,this.#e=function(t){const e=An("canvas");return e.style.cssText="\n    width: 100%;\n    height: 100%;\n    display: block;\n    touch-action: none;\n  ",e.width=t.width,e.height=t.height,e}(e);const n=this.#e.getContext("2d",{alpha:!1});if(null==n)throw Error("canvas context is null");this.#r=n;const r=An("div");r.style.cssText="width: 100%; height: 100%; position: relative;",r.appendChild(this.#e),t.appendChild(r),function(t){const e=t.createOscillator(),n=new Float32Array([0,0]),r=new Float32Array([0,0]),i=t.createPeriodicWave(n,r,{disableNormalization:!0});return e.setPeriodicWave(i),e.start(),e}(this.#n).connect(this.#c),Fn(this.#e,{x:0,y:0,w:0,h:0}),this.#t=new On,this.#p.push(function(t,e){const n=n=>{if(0!==n.button||n.target!==t)return;const r=In(t),{offsetX:i,offsetY:a}=n,o=i/r.w,s=a/r.h;e.activeSpriteByCoord(o,s)};return t.addEventListener("pointerdown",n),()=>{t.removeEventListener("pointerdown",n)}}(this.#e,this.#t),Pn(r,this.#e,this.#t),Ln(this.#e,this.#t,r),this.#t.on(Mn.AddSprite,(t=>{const{rect:e}=t;0===e.x&&0===e.y&&(e.x=(this.#e.width-e.w)/2,e.y=(this.#e.height-e.h)/2)})),l.forwardEvent(this.#t,this.#s,[Mn.ActiveSpriteChange]));let i=this.#a,a=performance.now(),o=0;const s=1e3/30;this.#l=S((()=>{(performance.now()-a)/(s*o)<1||(o+=1,this.#r.fillStyle=e.bgColor,this.#r.fillRect(0,0,this.#e.width,this.#e.height),this.#g(),i!==this.#a&&(i=this.#a,this.#s.emit("timeupdate",Math.round(i))))}),s)}#a=0;#d(t){this.#a=t,this.#t.updateRenderTime(t),this.#m.updateTime(t)}#h(){const t=0!==this.#i.step;this.#i.step=0,t&&(this.#s.emit("paused"),this.#n.suspend());for(const t of this.#u)t.stop(),t.disconnect();this.#u.clear(),this.#m.reset()}#n=new AudioContext;#c=this.#n.createMediaStreamDestination();#u=new Set;#g(){const t=this.#r;let e=this.#a;const{start:n,end:r,step:i,audioPlayAt:a}=this.#i;e+=i,0!==i&&e>=n&&e<r?this.#d(e):this.#h();const o=[];for(const n of this.#t.getSprites()){t.save();const{audio:r}=n.render(t,e-n.time.offset);t.restore(),o.push(r)}if(t.resetTransform(),0!==i){const t=Math.max(this.#n.currentTime,a),e=function(t,e){const n=[];if(0===t.length)return n;for(const[r,i]of t){if(null==r||r.length<=0)continue;const t=e.createBuffer(2,r.length,zn);t.copyToChannel(r,0),t.copyToChannel(i??r,1);const a=e.createBufferSource();a.buffer=t,n.push(a)}return n}(o,this.#n);let n=0;for(const r of e)r.start(t),r.connect(this.#n.destination),r.connect(this.#c),this.#u.add(r),r.onended=()=>{r.disconnect(),this.#u.delete(r)},n=Math.max(n,r.buffer?.duration??0);this.#i.audioPlayAt=t+n}}#i={start:0,end:0,step:0,audioPlayAt:0};play(t){const e=this.#t.getSprites({time:!1}).map((t=>t.time.offset+t.time.duration)),n=t.end??(e.length>0?Math.max(...e):1/0);if(t.start>=n||t.start<0)throw Error(`Invalid time parameter, ${JSON.stringify({start:t.start,end:n})}`);this.#d(t.start),this.#m.reset(),this.#i.start=t.start,this.#i.end=n,this.#i.step=(t.playbackRate??1)*(1e3/30)*1e3,this.#n.resume(),this.#i.audioPlayAt=0,this.#s.emit("playing"),m.info("AVCanvs play by:",this.#i)}#m=(()=>{const t=new Set;return{reset(){t.clear()},updateTime:R((e=>{const n=this.#t.getSprites({time:!1}).filter((t=>{const{offset:n}=t.time;return n>e&&n-1e6<=e}));for(const e of n)t.has(e)||e.preFrame(0),t.add(e)}),500)}})();pause(){this.#h()}async previewFrame(t){this.#h(),await Promise.all(this.#t.getSprites({time:!1}).map((e=>t>=e.time.offset&&t<=e.time.offset+e.time.duration?e.preFrame(t-e.time.offset):null))),this.#d(t)}captureImage(){return this.#e.toDataURL()}get activeSprite(){return this.#t.activeSprite}set activeSprite(t){this.#t.activeSprite=t}#f=new WeakMap;addSprite=async t=>{"suspended"===this.#n.state&&this.#n.resume().catch(m.error);const e=t.getClip();if(e instanceof ct&&null!=e.audioTrack){const n=this.#n.createMediaStreamSource(new MediaStream([e.audioTrack]));n.connect(this.#c),this.#f.set(t,n)}await this.#t.addSprite(t)};removeSprite=t=>{this.#f.get(t)?.disconnect(),this.#t.removeSprite(t)};destroy(){this.#o||(this.#o=!0,this.#n.close(),this.#c.disconnect(),this.#s.destroy(),this.#l(),this.#e.parentElement?.remove(),this.#p.forEach((t=>t())),this.#u.clear(),this.#t.destroy())}captureStream(){"suspended"===this.#n.state&&this.#n.resume().catch(m.error);const t=new MediaStream(this.#e.captureStream().getTracks().concat(this.#c.stream.getTracks()));return m.info("AVCanvas.captureStream, tracks:",t.getTracks().map((t=>t.kind))),t}async createCombinator(t={}){m.info("AVCanvas.createCombinator, opts:",t);const e=new Pt({...this.#y,...t}),n=this.#t.getSprites({time:!1});if(0===n.length)throw Error("No sprite added");for(const t of n){const n=new Rt(t.getClip());n.time={...t.time},t.copyStateTo(n),await e.addSprite(n)}return e}}var Un=function(){var t=s()(a()().mark((function t(e){var n;return a()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.licenseV2,t.next=3,Ge(n);case 3:if(t.sent){t.next=5;break}throw Error("license is invalid");case 5:return t.abrupt("return",{setTransition:nn,createCanvasFilter:Lt,cropClip:Vt,WebVTTClip:vn,renderFancyText:Se,FancyCaptionClip:ue,FancyTextClip:Be});case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()},55156:function(t,e,n){n.r(e),n.d(e,{CombinatorPlay:function(){return h}});var r=n(29008),i=n.n(r),a=n(70958),o=n.n(a),s=n(28633),c=n.n(s),l=n(21307),d=n(92379),u=n(651);function h(t){var e=t.list,n=t.onStart,r=t.com,a=t.stream,s=t.mediaType,h=void 0===s?"video":s,p=(0,d.useState)(""),f=c()(p,2),m=f[0],y=f[1],g=(0,d.useState)(""),w=c()(g,2),x=w[0],v=w[1];return(0,d.useEffect)((function(){o()(i()().mark((function t(){var e,n,o;return i()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!=r||null!=a){t.next=2;break}return t.abrupt("return");case 2:return y("合成中..."),n=performance.now(),t.next=6,new Response(null!==(e=null==r?void 0:r.output())&&void 0!==e?e:a).blob();case 6:o=t.sent,v(URL.createObjectURL(o)),y("合成耗时: ".concat(Math.round(performance.now()-n),"ms"));case 9:case"end":return t.stop()}}),t)})))()}),[r,a]),(0,u.jsxs)("div",{children:[(0,u.jsx)(l.ZP,{onClick:function(){y("loading..."),n()},style:{marginBottom:16},children:"启动！"}),e.length>0&&(0,u.jsxs)("div",{className:"resouse-list",children:["素材：",e.map((function(t){return(0,u.jsx)("a",{href:t,target:"_blank",style:{marginRight:"16px",textDecoration:"none"},children:t},t)}))]}),(0,u.jsxs)("div",{className:"state",children:[m,x.length>0&&(0,u.jsx)("a",{href:x,download:"WebAV-".concat(Date.now(),".").concat("video"===h?"mp4":"m4a"),target:"_self",style:{marginLeft:"16px",textDecoration:"none"},children:"导出视频"})]}),x.length>0&&("video"===h?(0,u.jsx)("video",{src:x,controls:!0,autoPlay:!0,style:{width:"600px",height:"333px",display:"block"}}):(0,u.jsx)("audio",{src:x,controls:!0,autoPlay:!0}))]})}},91953:function(t,e,n){n.r(e),n.d(e,{assetsPrefix:function(){return l},createFileWriter:function(){return d}});var r=n(29008),i=n.n(r),a=n(70958),o=n.n(a),s=n(28633),c=n.n(s);function l(t){var e=window.location.hostname.includes("webcontainer.io")||window.location.hostname.includes("stackblitz.io")||window.location.hostname.includes("csb.app")?"https://webav-tech.github.io/WebAV":"",n="/WebAV-Pro/";return Array.isArray(t)?t.map((function(t){return"".concat(e).concat(n).concat(t)})):Object.fromEntries(Object.entries(t).map((function(t){var r=c()(t,2),i=r[0],a=r[1];return[i,"".concat(e).concat(n).concat(a)]})))}function d(){return u.apply(this,arguments)}function u(){return u=o()(i()().mark((function t(){var e,n,r=arguments;return i()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=r.length>0&&void 0!==r[0]?r[0]:"mp4",t.next=3,window.showSaveFilePicker({suggestedName:"WebAV-export-".concat(Date.now(),".").concat(e)});case 3:return n=t.sent,t.abrupt("return",n.createWritable());case 5:case"end":return t.stop()}}),t)}))),u.apply(this,arguments)}},15566:function(t,e){e.Z="import { Radio, Space } from 'antd';\nimport { useState } from 'react';\n// @ts-ignore\nimport { AVCliper, AVProRegister } from '@webav/av-pro';\nimport { CombinatorPlay } from './combinator-player';\nimport { assetsPrefix } from './utils';\n\nconst { ImgClip, MP4Clip, Combinator, OffscreenSprite } = AVCliper;\nconst { setTransition } = await AVProRegister({\n  licenseV2: __WEBAV_PRO_LICENSE__,\n});\n\nconst transitionTypes = [\n  'fade',\n  'fadeblack',\n  'fadewhite',\n  'slideleft',\n  'slideright',\n  'slideup',\n  'slidedown',\n  'wipeleft',\n  'wiperight',\n  'wipeup',\n  'wipedown',\n  'wipeleft-slideup',\n] as const;\n\n// 转场类型到资源列表的映射\nconst transitionResourcesMap = {\n  'wipeleft-slideup': [\n    'video/bunny_0.mp4',\n    'video/bunny_1.mp4',\n    'video/bunny_2.mp4',\n  ],\n  fade: ['video/bunny_1.mp4', 'img/bunny.png'],\n  default: ['video/bunny_1.mp4'],\n};\n\n// 获取转场类型对应的资源列表\nfunction getResourcesForTransition(\n  type: (typeof transitionTypes)[number],\n): string[] {\n  if (type === 'wipeleft-slideup')\n    return transitionResourcesMap['wipeleft-slideup'];\n  if (type === 'fade') return transitionResourcesMap['fade'];\n  return transitionResourcesMap['default'];\n}\n\n// 创建多视频转场组合器\nasync function createMultiVideoTransition(\n  resources: string[],\n): Promise<AVCliper.Combinator> {\n  const [spr1, spr2, spr3] = await Promise.all(\n    resources.map(async (r, idx) => {\n      const spr = new OffscreenSprite(new MP4Clip((await fetch(r)).body!));\n      spr.time.offset = idx * 3e6;\n      spr.time.duration = 3e6;\n      spr.rect.w = 1280;\n      spr.rect.h = 720;\n      return spr;\n    }),\n  );\n\n  await setTransition('wipeleft', 1e6, [spr1, spr2]);\n  await setTransition('slideup', 1e6, [spr2, spr3]);\n\n  const com = new Combinator({\n    width: 1280,\n    height: 720,\n  });\n\n  await com.addSprite(spr1);\n  await com.addSprite(spr2);\n  await com.addSprite(spr3);\n\n  return com;\n}\n\n// 创建标准转场组合器\nasync function createStandardTransition(\n  resources: string[],\n  transitionType: (typeof transitionTypes)[number],\n): Promise<AVCliper.Combinator> {\n  const isFadeTransition = transitionType === 'fade';\n\n  // 创建第一个精灵\n  const spr1 = new OffscreenSprite(\n    new MP4Clip((await fetch(resources[0])).body!),\n  );\n  spr1.time.duration = isFadeTransition ? 3e6 : 2e6;\n  spr1.rect.w = 1280;\n  spr1.rect.h = 720;\n\n  // 创建第二个精灵\n  const spr2 = new OffscreenSprite(\n    isFadeTransition\n      ? new ImgClip(\n          await createImageBitmap(await (await fetch(resources[1])).blob()),\n        )\n      : new MP4Clip((await fetch(resources[0])).body!),\n  );\n\n  // 非淡入淡出转场需要设置时间偏移\n  if (!isFadeTransition) {\n    spr2.time.offset = 2e6;\n    spr2.time.duration = 2e6;\n  }\n  spr2.rect.w = 1280;\n  spr2.rect.h = 720;\n\n  // 创建组合器并添加精灵\n  const com = new Combinator({\n    width: 1280,\n    height: 720,\n  });\n\n  // @ts-ignore\n  await setTransition(transitionType, 1e6, [spr1, spr2]);\n  await com.addSprite(spr1, isFadeTransition ? { main: true } : undefined);\n  await com.addSprite(spr2);\n\n  return com;\n}\n\n// 重构后的主函数\nasync function createCombinator(\n  transitionType: (typeof transitionTypes)[number],\n) {\n  const resources = assetsPrefix(getResourcesForTransition(transitionType));\n\n  // 根据转场类型选择不同的处理函数\n  if (transitionType === 'wipeleft-slideup') {\n    return createMultiVideoTransition(resources);\n  }\n\n  return createStandardTransition(resources, transitionType);\n}\n\nexport default function UI() {\n  const [transitionType, setTransitionType] =\n    useState<(typeof transitionTypes)[number]>('fade');\n  const [com, setCom] = useState<null | AVCliper.Combinator>(null);\n  const [resList, setResList] = useState<string[]>([]);\n\n  // 根据选择的转场类型更新资源列表\n  const updateResList = (type: (typeof transitionTypes)[number]) => {\n    setResList(assetsPrefix(getResourcesForTransition(type)));\n  };\n\n  // 初始化资源列表\n  useState(() => {\n    updateResList(transitionType);\n  });\n\n  return (\n    <div>\n      <Space direction=\"vertical\" size=\"large\" style={{ width: '100%' }}>\n        <Radio.Group\n          onChange={(e) => {\n            const newType = e.target.value;\n            setTransitionType(newType);\n            updateResList(newType);\n          }}\n          value={transitionType}\n        >\n          <Space direction=\"horizontal\" wrap>\n            {transitionTypes.map((type) => (\n              <Radio key={type} value={type}>\n                {type}\n              </Radio>\n            ))}\n          </Space>\n        </Radio.Group>\n\n        <CombinatorPlay\n          list={resList}\n          onStart={async () => setCom(await createCombinator(transitionType))}\n          com={com}\n        />\n      </Space>\n    </div>\n  );\n}\n"},25042:function(t,e){e.Z="import { Radio, Space } from 'antd';\nimport { useState } from 'react';\n// @ts-ignore\nimport { AVCliper, AVProRegister } from '@webav/av-pro';\nimport { CombinatorPlay } from './combinator-player';\nimport { assetsPrefix } from './utils';\n\nconst { Combinator, MP4Clip, OffscreenSprite } = AVCliper;\n\nconst { createCanvasFilter } = await AVProRegister({\n  licenseV2: __WEBAV_PRO_LICENSE__,\n});\n\n// 定义可用的滤镜类型\nconst filterTypes = [\n  'blur(5px)',\n  'brightness(150%)',\n  'contrast(200%)',\n  'grayscale(100%)',\n  'hue-rotate(90deg)',\n  'invert(100%)',\n  'opacity(70%)',\n  'saturate(200%)',\n  'sepia(100%)',\n] as const;\n\n// 资源列表\nconst resList = assetsPrefix(['video/bunny_1.mp4']);\n\n// 创建组合器函数\nasync function createCombinator(filterType: string) {\n  const width = 1280;\n  const height = 720;\n\n  // 创建原始视频精灵\n  const originSpr = new OffscreenSprite(\n    new MP4Clip((await fetch(resList[0])).body!),\n  );\n  await originSpr.ready;\n  originSpr.zIndex = 1;\n  // 修改间隔为20像素\n  originSpr.rect.x = (width - originSpr.rect.w * 2 - 20) / 2;\n  originSpr.rect.y = (height - originSpr.rect.h) / 2;\n\n  // 创建应用滤镜的视频剪辑\n  const filterClip = new MP4Clip((await fetch(resList[0])).body!);\n\n  // 创建滤镜函数\n  const filter = createCanvasFilter(filterType);\n\n  // @ts-ignore\n  // 使用 tickInterceptor 在每一帧应用滤镜\n  filterClip.tickInterceptor = async (_, tickRet) => {\n    if (tickRet.video == null) return tickRet;\n    return {\n      ...tickRet,\n      video: filter(tickRet.video),\n    };\n  };\n\n  // 创建应用了滤镜的视频精灵\n  const filterSpr = new OffscreenSprite(filterClip);\n  await filterSpr.ready;\n  filterSpr.zIndex = 1;\n  // 修改间隔为20像素\n  filterSpr.rect.x = originSpr.rect.x + filterSpr.rect.w + 20;\n  filterSpr.rect.y = (height - filterSpr.rect.h) / 2;\n\n  // 同样限制原始视频时长为10秒，保持一致\n  originSpr.time.duration = 10 * 1e6;\n\n  // 创建组合器\n  const com = new Combinator({ width, height, bgColor: 'white' });\n\n  // 添加精灵到组合器\n  await com.addSprite(originSpr, { main: true });\n  await com.addSprite(filterSpr);\n\n  return com;\n}\n\n// UI 组件\nexport default function UI() {\n  const [filterType, setFilterType] = useState<string>(filterTypes[0]);\n  const [com, setCom] = useState<null | AVCliper.Combinator>(null);\n\n  return (\n    <div>\n      <Space direction=\"vertical\" size=\"large\" style={{ width: '100%' }}>\n        <Radio.Group\n          onChange={(e) => {\n            setFilterType(e.target.value);\n          }}\n          value={filterType}\n        >\n          <Space direction=\"horizontal\" wrap>\n            {filterTypes.map((type) => (\n              <Radio key={type} value={type}>\n                {type}\n              </Radio>\n            ))}\n          </Space>\n        </Radio.Group>\n\n        <CombinatorPlay\n          list={resList}\n          onStart={async () => setCom(await createCombinator(filterType))}\n          com={com}\n        />\n      </Space>\n    </div>\n  );\n}\n"},1354:function(t,e){e.Z="import { AVCliper, AVProRegister } from '@webav/av-pro';\nimport { Col, message, Radio, Row, Slider, Space } from 'antd';\nimport { useEffect, useState } from 'react';\nimport { CombinatorPlay } from './combinator-player';\nimport { assetsPrefix } from './utils';\n\nconst { Combinator, MP4Clip, OffscreenSprite } = AVCliper;\n\nconst { cropClip } = await AVProRegister({\n  licenseV2: __WEBAV_PRO_LICENSE__,\n});\n\n// 裁剪模式\nenum CropMode {\n  RATIO = 'ratio',\n  AREA = 'area',\n}\n\n// 常用比例\nconst ratios = [\n  { label: '4:3', value: 4 / 3 },\n  { label: '1:1', value: 1 },\n  { label: '9:16', value: 9 / 16 },\n  { label: '3:4', value: 3 / 4 },\n];\n\n// 资源列表\nconst resList = assetsPrefix(['video/bunny_1.mp4']);\n\n// 创建组合器函数\nasync function createCombinator(\n  cropValue: number | { x: number; y: number; w: number; h: number },\n) {\n  const width = 1280;\n  const height = 720;\n\n  // 创建原始视频精灵\n  const originClip = new MP4Clip((await fetch(resList[0])).body!);\n  const originSpr = new OffscreenSprite(originClip);\n  await originSpr.ready;\n  originSpr.zIndex = 1;\n\n  // 创建裁剪后的视频剪辑\n  const croppedClip = new MP4Clip((await fetch(resList[0])).body!);\n\n  // 根据裁剪模式应用裁剪\n  // @ts-ignore\n  const processedClip = await cropClip(croppedClip, cropValue);\n\n  // 创建裁剪后的视频精灵\n  const croppedSpr = new OffscreenSprite(processedClip);\n  await croppedSpr.ready;\n  croppedSpr.zIndex = 1;\n\n  // 设置精灵位置\n  originSpr.rect.x = 50;\n  originSpr.rect.y = (height - originSpr.rect.h) / 2;\n\n  croppedSpr.rect.x = width - croppedSpr.rect.w - 50;\n  croppedSpr.rect.y = (height - croppedSpr.rect.h) / 2;\n\n  // 限制视频时长为10秒\n  originSpr.time.duration = 10 * 1e6;\n  croppedSpr.time.duration = 10 * 1e6;\n\n  // 创建组合器\n  const com = new Combinator({ width, height, bgColor: 'white' });\n\n  // 添加精灵到组合器\n  await com.addSprite(originSpr, { main: true });\n  await com.addSprite(croppedSpr);\n\n  return com;\n}\n\n// UI 组件\nexport default function UI() {\n  const [cropMode, setCropMode] = useState<CropMode>(CropMode.RATIO);\n  const [ratioValue, setRatioValue] = useState<number>(4 / 3);\n  const [areaValue, setAreaValue] = useState<{\n    x: number;\n    y: number;\n    w: number;\n    h: number;\n  }>({\n    x: 0,\n    y: 0,\n    w: 400,\n    h: 300,\n  });\n  const [originalSize, setOriginalSize] = useState<{\n    width: number;\n    height: number;\n  } | null>(null);\n  const [com, setCom] = useState<null | AVCliper.Combinator>(null);\n\n  // 加载原始视频尺寸\n  useEffect(() => {\n    async function loadOriginalSize() {\n      try {\n        const clip = new MP4Clip((await fetch(resList[0])).body!);\n        const { width, height } = await clip.ready;\n        setOriginalSize({ width, height });\n\n        // 更新默认区域值为视频中心的一部分\n        setAreaValue({\n          x: 0,\n          y: 0,\n          w: Math.floor(width * 0.5),\n          h: Math.floor(height * 0.5),\n        });\n\n        clip.destroy();\n      } catch (error) {\n        console.error('Failed to load video size:', error);\n      }\n    }\n\n    loadOriginalSize();\n  }, []);\n\n  // 处理裁剪参数变化\n  const handleCrop = async () => {\n    try {\n      const cropValue = cropMode === CropMode.RATIO ? ratioValue : areaValue;\n      setCom(await createCombinator(cropValue));\n    } catch (error) {\n      message.error(`裁剪失败: ${(error as Error).message}`);\n    }\n  };\n\n  return (\n    <div>\n      <Space direction=\"vertical\" size=\"large\" style={{ width: '100%' }}>\n        <Radio.Group\n          onChange={(e) => setCropMode(e.target.value)}\n          value={cropMode}\n        >\n          <Radio value={CropMode.RATIO}>按比例裁剪</Radio>\n          <Radio value={CropMode.AREA}>指定区域裁剪</Radio>\n        </Radio.Group>\n\n        {cropMode === CropMode.RATIO ? (\n          <div>\n            <Radio.Group\n              onChange={(e) => setRatioValue(e.target.value)}\n              value={ratioValue}\n            >\n              <Space direction=\"horizontal\" wrap>\n                {ratios.map((ratio) => (\n                  <Radio key={ratio.label} value={ratio.value}>\n                    {ratio.label}\n                  </Radio>\n                ))}\n              </Space>\n            </Radio.Group>\n          </div>\n        ) : (\n          <div>\n            {originalSize && (\n              <>\n                <p>\n                  原始视频尺寸: {originalSize.width} x {originalSize.height}\n                </p>\n                <Row gutter={16}>\n                  <Col span={12}>\n                    <div>X 坐标 (0-{originalSize.width})</div>\n                    <Slider\n                      min={0}\n                      max={originalSize.width - areaValue.w}\n                      value={areaValue.x}\n                      onChange={(value) =>\n                        setAreaValue({ ...areaValue, x: value })\n                      }\n                    />\n                  </Col>\n                  <Col span={12}>\n                    <div>Y 坐标 (0-{originalSize.height})</div>\n                    <Slider\n                      min={0}\n                      max={originalSize.height - areaValue.h}\n                      value={areaValue.y}\n                      onChange={(value) =>\n                        setAreaValue({ ...areaValue, y: value })\n                      }\n                    />\n                  </Col>\n                </Row>\n                <Row gutter={16}>\n                  <Col span={12}>\n                    <div>宽度 (1-{originalSize.width - areaValue.x})</div>\n                    <Slider\n                      min={2}\n                      max={originalSize.width - areaValue.x}\n                      value={areaValue.w}\n                      onChange={(value) =>\n                        setAreaValue({ ...areaValue, w: value })\n                      }\n                    />\n                  </Col>\n                  <Col span={12}>\n                    <div>高度 (1-{originalSize.height - areaValue.y})</div>\n                    <Slider\n                      min={2}\n                      max={originalSize.height - areaValue.y}\n                      value={areaValue.h}\n                      onChange={(value) =>\n                        setAreaValue({ ...areaValue, h: value })\n                      }\n                    />\n                  </Col>\n                </Row>\n              </>\n            )}\n          </div>\n        )}\n\n        <CombinatorPlay list={resList} onStart={handleCrop} com={com} />\n      </Space>\n    </div>\n  );\n}\n"},12717:function(t,e){e.Z="import { AVCliper, AVProRegister } from '@webav/av-pro';\nimport { Space } from 'antd';\nimport { useState } from 'react';\nimport { CombinatorPlay } from './combinator-player';\nimport { assetsPrefix } from './utils';\n\nconst { Combinator, MP4Clip, OffscreenSprite } = AVCliper;\n\nconst { WebVTTClip } = await AVProRegister({\n  licenseV2: __WEBAV_PRO_LICENSE__,\n});\n\n// 示例 WebVTT 内容\nconst sampleVttContent = `WEBVTT\n\nSTYLE\n::cue {\n  background-image: url(../img/webvtt-bgimg.png);\n  color: black;\n  font-size: 40px;\n  padding: 12px 16px;\n  border-radius: 10px;\n}\n\nSTYLE\nvideo::cue(b) {\n  color: orange;\n}\n\nSTYLE\nvideo::cue(.highlight) {\n  color: red;\n}\n\n1\n00:00:00.000 --\x3e 00:00:01.466\n<b>比特币</b>自<c.highlight>2月</c>以来\n\n2\n00:00:01.466 --\x3e 00:00:03.466\n首次<c.highlight>突破10万</c>美元大关\n\n3\n00:00:03.533 --\x3e 00:00:06.066\n全球贸易紧张局势缓解的预期\n\n4\n00:00:06.066 --\x3e 00:00:07.333\n为其带来提振\n\n5\n00:00:07.433 --\x3e 00:00:10.833\n该数字资产周四一度上涨<c.highlight>4.9%</c>\n\n6\n00:00:10.833 --\x3e 00:00:13.000\n至<c.highlight>101,519美元</c>\n\n7\n00:00:13.066 --\x3e 00:00:15.233\n其他主要代币也大多上涨\n\n8\n00:00:15.300 --\x3e 00:00:17.833\n<b>1月20日</b> 美国总统<b>特朗普</b>\n\n9\n00:00:17.933 --\x3e 00:00:19.400\n第二个任期的就职典礼\n\n10\n00:00:19.400 --\x3e 00:00:20.066\n当天\n\n11\n00:00:20.133 --\x3e 00:00:23.366\n<b>比特币</b>价格一度升至<c.highlight>10.9万美元</c>左右\n\n12\n00:00:23.433 --\x3e 00:00:24.833\n创下<c.highlight>记录新高</c>\n\n13\n00:00:24.900 --\x3e 00:00:27.233\n而后随着<b>特朗普</b>推进关税计划\n\n14\n00:00:27.733 --\x3e 00:00:30.000\n引发全球金融市场动荡\n\n15\n00:00:30.066 --\x3e 00:00:32.400\n<b>比特币</b>一度<c.highlight>暴跌30%</c>`;\n\n// 资源列表\nconst resList = assetsPrefix(['video/webvtt-example.mp4']);\n\n// 创建组合器函数\nasync function createCombinator() {\n  const width = 1280;\n  const height = 720;\n\n  // 创建视频精灵\n  const videoSpr = new OffscreenSprite(\n    new MP4Clip((await fetch(resList[0])).body!),\n  );\n  await videoSpr.ready;\n  videoSpr.zIndex = 1;\n\n  // 创建字幕精灵\n  const vttClip = new WebVTTClip(sampleVttContent, {\n    videoWidth: width,\n    videoHeight: height,\n  });\n\n  const subtitleSpr = new OffscreenSprite(vttClip);\n  await subtitleSpr.ready;\n  subtitleSpr.zIndex = 2;\n\n  // 限制视频时长为10秒\n  // videoSpr.time.duration = 10 * 1e6;\n\n  // 创建组合器\n  const com = new Combinator({ width, height, bgColor: 'black' });\n\n  // 添加精灵到组合器\n  await com.addSprite(videoSpr, { main: true });\n  await com.addSprite(subtitleSpr);\n\n  return com;\n}\n\n// UI 组件\nexport default function UI() {\n  const [com, setCom] = useState<null | AVCliper.Combinator>(null);\n\n  return (\n    <div>\n      <Space direction=\"vertical\" size=\"large\" style={{ width: '100%' }}>\n        <CombinatorPlay\n          list={resList}\n          onStart={async () => setCom(await createCombinator())}\n          com={com}\n        />\n      </Space>\n    </div>\n  );\n}\n"},73602:function(t,e){e.Z="import { AVCliper } from '@webav/av-pro';\nimport { useState } from 'react';\nimport { CombinatorPlay } from './combinator-player';\nimport { assetsPrefix } from './utils';\n\nconst { Combinator, ImgClip, MP4Clip, OffscreenSprite, createChromakey } =\n  AVCliper;\n\nconst resList = assetsPrefix(['video/chromakey-test.mp4', 'img/bunny.png']);\n\nconst chromakey = createChromakey({\n  // 未设置 keyColor 默认取左上角第一个像素的颜色值\n  // keyColor: '#00FF00'\n  similarity: 0.33,\n  smoothness: 0.1,\n  spill: 0.1,\n});\n\nasync function start() {\n  const width = 1280;\n  const height = 720;\n\n  const originSpr = new OffscreenSprite(\n    new MP4Clip((await fetch(resList[0])).body!),\n  );\n  await originSpr.ready;\n  originSpr.zIndex = 1;\n  originSpr.rect.x = (width - originSpr.rect.w * 2 - 100) / 2;\n  originSpr.rect.y = (height - originSpr.rect.h) / 2;\n\n  const targetClip = new MP4Clip((await fetch(resList[0])).body!);\n  targetClip.tickInterceptor = async (_, tickRet) => {\n    if (tickRet.video == null) return tickRet;\n    return {\n      ...tickRet,\n      video: await chromakey(tickRet.video),\n    };\n  };\n\n  const targetSpr = new OffscreenSprite(targetClip);\n  await targetSpr.ready;\n  targetSpr.zIndex = 1;\n  targetSpr.rect.x = originSpr.rect.x + targetSpr.rect.w + 100;\n  targetSpr.rect.y = (height - targetSpr.rect.h) / 2;\n\n  const bgImgSpr = new OffscreenSprite(\n    new ImgClip(\n      await createImageBitmap(await (await fetch(resList[1])).blob()),\n    ),\n  );\n\n  const com = new Combinator({ width, height, bgColor: 'white' });\n\n  await com.addSprite(originSpr, { main: true });\n  await com.addSprite(targetSpr);\n  await com.addSprite(bgImgSpr);\n  return com;\n}\n\nexport default function UI() {\n  const [com, setCom] = useState<null | AVCliper.Combinator>(null);\n  return (\n    <CombinatorPlay\n      list={resList}\n      onStart={async () => setCom(await start())}\n      com={com}\n    ></CombinatorPlay>\n  );\n}\n"},90076:function(t,e){e.Z="import { AVProRegister, IFancyTextConf } from '@webav/av-pro';\nimport { Spin } from 'antd';\nimport { useEffect, useRef, useState } from 'react';\nimport { assetsPrefix } from './utils';\n\n// 花字示例接口\ninterface FancyTextExample {\n  text: string;\n  conf: IFancyTextConf;\n  title?: string;\n}\n\nconst { renderFancyText } = await AVProRegister({\n  licenseV2: __WEBAV_PRO_LICENSE__,\n});\n\n// 创建一个简单的背景图片\nasync function createBackgroundImage(): Promise<ImageBitmap> {\n  // 创建一个简单的渐变背景\n  const tempCanvas = new OffscreenCanvas(100, 100);\n  const tempCtx = tempCanvas.getContext('2d')!;\n  tempCtx.textBaseline = 'top';\n  tempCtx.lineCap = 'round';\n  tempCtx.lineJoin = 'round';\n\n  // 创建渐变背景\n  const gradient = tempCtx.createLinearGradient(0, 0, 100, 100);\n  gradient.addColorStop(0, 'rgba(255, 200, 100, 0.7)');\n  gradient.addColorStop(1, 'rgba(100, 150, 255, 0.7)');\n\n  tempCtx.fillStyle = gradient;\n  tempCtx.fillRect(0, 0, 100, 100);\n\n  // 添加一些图案\n  tempCtx.strokeStyle = 'rgba(255, 255, 255, 0.5)';\n  tempCtx.lineWidth = 2;\n  tempCtx.beginPath();\n  tempCtx.moveTo(0, 0);\n  tempCtx.lineTo(100, 100);\n  tempCtx.moveTo(0, 100);\n  tempCtx.lineTo(100, 0);\n  tempCtx.stroke();\n\n  return createImageBitmap(tempCanvas);\n}\n\nasync function loadFireTexture(url: string): Promise<ImageBitmap> {\n  const imgUrl = assetsPrefix([url])[0];\n  const response = await fetch(imgUrl);\n  const blob = await response.blob();\n  return createImageBitmap(blob);\n}\n\n// 创建花字示例数据\nasync function createFancyTextExamplesByAI(): Promise<FancyTextExample[]> {\n  const bgImageBitmap = await createBackgroundImage();\n\n  return [\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: 'black',\n            lineWidth: 8,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: 'white',\n            shadow: '',\n          },\n        ],\n      },\n    },\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#0000cc',\n            lineWidth: 5,\n          },\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#ffcc00',\n            lineWidth: 2,\n            x: -1,\n            y: -1,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: '#3366ff',\n            shadow: '',\n          },\n        ],\n      },\n    },\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#333',\n            lineWidth: 1,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: 'white',\n            shadow: '2 2 3 rgba(0,0,0,0.5)',\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: 'white',\n            shadow: '4 4 6 rgba(0,0,255,0.3)',\n            x: 1,\n            y: 1,\n          },\n        ],\n      },\n    },\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#000',\n            lineWidth: 4,\n          },\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#fff',\n            lineWidth: 2,\n            x: -1,\n            y: -1,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: '#333',\n            shadow: '',\n          },\n        ],\n      },\n    },\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            type: 'img',\n            data: bgImageBitmap,\n            style: 'perChar',\n          },\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#993300',\n            lineWidth: 2,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: '#ff9933',\n            shadow: '1 1 5 rgba(255,165,0,0.7)',\n          },\n        ],\n      },\n    },\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#330066',\n            lineWidth: 3,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: '#9933ff',\n            shadow: '2 2 4 rgba(128,0,128,0.6)',\n          },\n        ],\n      },\n    },\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#003366',\n            lineWidth: 2,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: '#66ccff',\n            shadow: '1 1 4 rgba(135,206,250,0.7)',\n          },\n        ],\n      },\n    },\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#cc0066',\n            lineWidth: 4,\n          },\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#ff99cc',\n            lineWidth: 1,\n            x: -1,\n            y: -1,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: '#ff3399',\n            shadow: '1 1 3 rgba(255,105,180,0.5)',\n          },\n        ],\n      },\n    },\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#ff0000',\n            lineWidth: 4,\n          },\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#ffff00',\n            lineWidth: 3,\n            x: 1,\n            y: 1,\n          },\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#00ff00',\n            lineWidth: 2,\n            x: 2,\n            y: 2,\n          },\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#0000ff',\n            lineWidth: 1,\n            x: 3,\n            y: 3,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: 'white',\n            shadow: '',\n          },\n        ],\n      },\n    },\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            type: 'img',\n            data: bgImageBitmap,\n            style: 'stretch',\n          },\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#333333',\n            lineWidth: 3,\n          },\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#cccccc',\n            lineWidth: 1,\n            x: -1,\n            y: -1,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: '#999999',\n            shadow: '1 1 3 rgba(192,192,192,0.8)',\n          },\n        ],\n      },\n    },\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#FFFFFF',\n            lineWidth: 10,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: '#777CE6',\n            shadow: '10 10 0 rgb(255 255 255)',\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: '#777CE6',\n            shadow: '10 10 20 rgb(119 126 230)',\n            x: 1,\n            y: 1,\n          },\n        ],\n      },\n    },\n  ];\n}\n\nasync function createFancyTextExamplesByHuman(): Promise<FancyTextExample[]> {\n  // 加载字体\n  try {\n    // 等待字体就绪\n    await document.fonts.ready;\n\n    // 创建并加载字体\n    const fontFace = new FontFace(\n      'muyaoruanbi',\n      `url('${assetsPrefix(['fonts/muyaoruanbi.ttf'])[0]}')`,\n    );\n\n    // 等待字体加载完成\n    const loadedFace = await fontFace.load();\n\n    // 将字体添加到文档中\n    // @ts-ignore - 使用 ts-ignore 忽略类型检查错误\n    document.fonts.add(loadedFace);\n\n    // 确保字体可用\n    await document.fonts.ready;\n  } catch (error) {\n    console.error('字体加载失败:', error);\n  }\n\n  return [\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            x: -8,\n            y: -8,\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#FFFFFF',\n            lineWidth: 16,\n          },\n          {\n            x: -4,\n            y: -4,\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#0B3AB7',\n            lineWidth: 8,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: '#FFCF02',\n          },\n        ],\n      },\n    },\n\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            type: 'fillText',\n            x: 4,\n            y: 4,\n            font: 'bold 100px Arial',\n            style: '#FFFFFF',\n          },\n          {\n            type: 'strokeText',\n            x: 4,\n            y: 4,\n            font: 'bold 100px Arial',\n            style: '#FFFFFF',\n            lineWidth: 4,\n          },\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#FFFFFF',\n            x: -3,\n            y: -3,\n            lineWidth: 6,\n            shadow: '2 2 6 #777CE6',\n          },\n          {\n            type: 'fillText',\n            font: '100px Arial',\n            style: '#777CE6',\n          },\n        ],\n        animation: {\n          in: {\n            type: 'slideInLeft',\n            duration: 1e6,\n          },\n        },\n      },\n    },\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#FF9CDB',\n            x: -10,\n            y: -10,\n            lineWidth: 20,\n          },\n          {\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#FFFFFF',\n            x: -5,\n            y: -5,\n            lineWidth: 10,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: 'linear-gradient(0, 0, 0, 1, #7ADFFE 0, #FF9CDB 1)',\n          },\n        ],\n      },\n    },\n    // pixi 绘制，暂不支持纹理\n    // {\n    //   text: '花字',\n    //   conf: {\n    //     letterSpacing: 0,\n    //     layers: [\n    //       {\n    //         type: 'strokeText',\n    //         font: 'bold 100px Arial',\n    //         style: '#FFFFFF',\n    //         lineWidth: 8,\n    //       },\n    //       {\n    //         type: 'fillText',\n    //         font: 'bold 100px Arial',\n    //         style: async (ctx) =>\n    //           ctx.createPattern(\n    //             await loadFireTexture('img/fancytext-pattern.png'),\n    //             'repeat',\n    //           )!,\n    //       },\n    //     ],\n    //   },\n    // },\n    {\n      text: '花字',\n      conf: {\n        letterSpacing: 0,\n        layers: [\n          {\n            x: 6,\n            y: 6,\n            type: 'fillText',\n            font: '100px muyaoruanbi',\n            style: '#F78F40',\n          },\n          {\n            x: -2,\n            y: -2,\n            type: 'strokeText',\n            font: 'bold 100px muyaoruanbi',\n            style: '#F5C6A6',\n            lineWidth: 4,\n          },\n          {\n            type: 'fillText',\n            font: '100px muyaoruanbi',\n            style: '#E05A23',\n          },\n        ],\n      },\n    },\n    {\n      text: '默认文本',\n      conf: {\n        letterSpacing: 20,\n        layers: [\n          {\n            type: 'img',\n            x: -15,\n            y: -25,\n            w: 150,\n            h: 130,\n            data: await (async () => {\n              try {\n                return await loadFireTexture('img/fire.png');\n              } catch (e) {\n                throw e;\n              }\n            })(),\n            style: 'perChar',\n          },\n          {\n            x: -9,\n            y: -9,\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#FBEF20',\n            lineWidth: 18,\n          },\n          {\n            x: -6,\n            y: -6,\n            type: 'strokeText',\n            font: 'bold 100px Arial',\n            style: '#F00000',\n            lineWidth: 12,\n          },\n          {\n            type: 'fillText',\n            font: 'bold 100px Arial',\n            style: 'linear-gradient(0, 0, 0, 1, #FFFFFF 0, #FFFF00 1)',\n          },\n        ],\n      },\n    },\n  ];\n}\n\n// 示例项组件（直接接收已生成的 ImageBitmap）\nconst ExampleItem = ({\n  imgBitmap: example,\n  handleExampleClick,\n}: {\n  imgBitmap: ImageBitmap;\n  handleExampleClick: (example: ImageBitmap) => void;\n}) => {\n  const [imgSrc, setImgSrc] = useState('');\n\n  useEffect(() => {\n    let url = '';\n    const toUrl = async () => {\n      const tempOffscreenCanvas = new OffscreenCanvas(\n        example.width,\n        example.height,\n      );\n      const tempOffscreenCtx = tempOffscreenCanvas.getContext('2d')!;\n      tempOffscreenCtx.drawImage(example, 0, 0);\n\n      const blob = await tempOffscreenCanvas.convertToBlob({\n        type: 'image/png',\n      });\n      url = URL.createObjectURL(blob);\n      setImgSrc(url);\n    };\n    toUrl();\n\n    return () => {\n      if (url) URL.revokeObjectURL(url);\n    };\n  }, [example]);\n\n  return (\n    <div\n      className=\"example-item\"\n      style={{\n        backgroundColor: '#333',\n        borderRadius: '8px',\n        boxShadow: '0 2px 10px rgba(0, 0, 0, 0.1)',\n        overflow: 'hidden',\n        transition: 'transform 0.2s',\n        cursor: 'pointer',\n        position: 'relative',\n      }}\n      onClick={() => handleExampleClick(example)}\n    >\n      <div\n        className=\"example-image\"\n        style={{\n          width: '100%',\n          height: '100px',\n          display: 'flex',\n          alignItems: 'center',\n          justifyContent: 'center',\n        }}\n      >\n        {imgSrc ? (\n          <img\n            src={imgSrc}\n            alt=\"fancy-text\"\n            style={{\n              maxWidth: '100%',\n              maxHeight: '100%',\n            }}\n          />\n        ) : (\n          <Spin size=\"small\" />\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default function FancyTextDemo() {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [aiExamples, setAiExamples] = useState<ImageBitmap[]>([]);\n  const [humanExamples, setHumanExamples] = useState<ImageBitmap[]>([]);\n  const [sizeInfo, setSizeInfo] = useState('尺寸信息: 宽度=0, 高度=0');\n  const [loading, setLoading] = useState(true);\n\n  // 初始化示例数据\n  useEffect(() => {\n    const init = async () => {\n      setLoading(true);\n      try {\n        // 创建示例\n        const aiData = await createFancyTextExamplesByAI();\n        const humanData = await createFancyTextExamplesByHuman();\n\n        // 串行生成 ImageBitmap，避免并发占用过多 WebGL 上下文\n        const aiBmps: ImageBitmap[] = [];\n        for (const ex of aiData) {\n          const bmp = await renderFancyText(ex.text, ex.conf);\n          aiBmps.push(bmp);\n        }\n\n        const humanBmps: ImageBitmap[] = [];\n        for (const ex of humanData) {\n          const bmp = await renderFancyText(ex.text, ex.conf);\n          humanBmps.push(bmp);\n        }\n\n        setAiExamples(aiBmps);\n        setHumanExamples(humanBmps);\n      } catch (error) {\n        console.error('初始化失败:', error);\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    init();\n  }, []);\n\n  // 初始化预览画布\n  useEffect(() => {\n    if (!canvasRef.current) return;\n    const canvas = canvasRef.current;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    ctx.fillStyle = '#333';\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n  }, []);\n\n  // 渲染示例到预览画布\n  const handleExampleClick = async (example: ImageBitmap) => {\n    if (!canvasRef.current) return;\n    const canvas = canvasRef.current;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    // 清空画布\n    ctx.fillStyle = '#333';\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n\n    // 直接使用已生成的 ImageBitmap\n    const bitmap = example;\n    ctx.drawImage(bitmap, 0, 0);\n\n    // 更新尺寸信息\n    setSizeInfo(\n      `尺寸信息: 宽度=${bitmap.width.toFixed(0)}, 高度=${bitmap.height.toFixed(0)}`,\n    );\n  };\n\n  if (loading) {\n    return (\n      <div style={{ textAlign: 'center', padding: '50px 0' }}>\n        <Spin tip=\"加载中...\" size=\"large\" />\n      </div>\n    );\n  }\n\n  return (\n    <div>\n      <div className=\"section\" style={{ marginBottom: '30px' }}>\n        <h2>AI 生成花字示例</h2>\n        <div\n          className=\"examples-grid\"\n          style={{\n            display: 'grid',\n            gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))',\n            gap: '15px',\n            marginBottom: '30px',\n          }}\n        >\n          {aiExamples.map((example, index) => (\n            <ExampleItem\n              key={`ai-${index}`}\n              imgBitmap={example}\n              handleExampleClick={handleExampleClick}\n            />\n          ))}\n        </div>\n      </div>\n\n      <div className=\"section\" style={{ marginBottom: '30px' }}>\n        <h2>人工配置花字示例</h2>\n        <div\n          className=\"examples-grid\"\n          style={{\n            display: 'grid',\n            gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))',\n            gap: '15px',\n            marginBottom: '30px',\n          }}\n        >\n          {humanExamples.map((example, index) => (\n            <ExampleItem\n              key={`human-${index}`}\n              imgBitmap={example}\n              handleExampleClick={handleExampleClick}\n            />\n          ))}\n        </div>\n      </div>\n\n      <div className=\"section\" style={{ marginBottom: '30px' }}>\n        <h2>预览效果</h2>\n        <div\n          className=\"preview-container\"\n          style={{\n            display: 'flex',\n            flexDirection: 'column',\n            alignItems: 'center',\n          }}\n        >\n          <canvas\n            ref={canvasRef}\n            width={800}\n            height={150}\n            style={{\n              border: '1px solid #ddd',\n              marginBottom: '20px',\n              backgroundColor: '#333',\n              maxWidth: '100%',\n            }}\n          />\n          <div\n            className=\"info-text\"\n            style={{ marginTop: '10px', color: '#666' }}\n          >\n            {sizeInfo}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n"},48741:function(t,e){e.Z="import { Combinator } from '@webav/av-cliper';\nimport { Button } from 'antd';\nimport { useEffect, useState } from 'react';\n\nexport function CombinatorPlay({\n  list,\n  onStart,\n  com,\n  stream,\n  mediaType = 'video',\n}: {\n  list: string[];\n  onStart: () => void;\n  com?: Combinator | null;\n  stream?: ReadableStream | null;\n  mediaType?: 'video' | 'audio';\n}) {\n  const [state, setState] = useState('');\n  const [videoSrc, setVideoSrc] = useState('');\n\n  useEffect(() => {\n    (async () => {\n      if (com == null && stream == null) return;\n      setState('合成中...');\n      const timeStart = performance.now();\n      const srcBlob = await new Response(com?.output() ?? stream).blob();\n      setVideoSrc(URL.createObjectURL(srcBlob));\n      setState(`合成耗时: ${Math.round(performance.now() - timeStart)}ms`);\n    })();\n  }, [com, stream]);\n  return (\n    <div>\n      <Button\n        onClick={() => {\n          setState('loading...');\n          onStart();\n        }}\n        style={{ marginBottom: 16 }}\n      >\n        启动！\n      </Button>\n      {list.length > 0 && (\n        <div className=\"resouse-list\">\n          素材：\n          {list.map((it) => (\n            <a\n              href={it}\n              target=\"_blank\"\n              key={it}\n              style={{ marginRight: '16px', textDecoration: 'none' }}\n            >\n              {it}\n            </a>\n          ))}\n        </div>\n      )}\n      <div className=\"state\">\n        {state}\n        {videoSrc.length > 0 && (\n          <a\n            href={videoSrc}\n            download={`WebAV-${Date.now()}.${\n              mediaType === 'video' ? 'mp4' : 'm4a'\n            }`}\n            target=\"_self\"\n            style={{ marginLeft: '16px', textDecoration: 'none' }}\n          >\n            导出视频\n          </a>\n        )}\n      </div>\n      {videoSrc.length > 0 &&\n        (mediaType === 'video' ? (\n          <video\n            src={videoSrc}\n            controls\n            autoPlay\n            style={{\n              width: '600px',\n              height: '333px',\n              display: 'block',\n            }}\n          ></video>\n        ) : (\n          <audio src={videoSrc} controls autoPlay></audio>\n        ))}\n    </div>\n  );\n}\n"},52638:function(t,e){e.Z="const BASE_URL = 'https://webav-tech.github.io/WebAV';\nexport function assetsPrefix<T extends string[] | Record<string, string>>(\n  assetsURL: T,\n): T {\n  const base =\n    window.location.hostname.includes('webcontainer.io') ||\n    window.location.hostname.includes('stackblitz.io') ||\n    window.location.hostname.includes('csb.app')\n      ? BASE_URL\n      : '';\n  const prefix = process.env.NODE_ENV === 'development' ? '/' : '/WebAV-Pro/';\n  if (Array.isArray(assetsURL)) {\n    return assetsURL.map((url) => `${base}${prefix}${url}`) as T;\n  }\n\n  return Object.fromEntries(\n    Object.entries(assetsURL).map(([k, v]) => [k, `${base}${prefix}${v}`]),\n  ) as T;\n}\n\nexport async function createFileWriter(\n  extName = 'mp4',\n): Promise<FileSystemWritableFileStream> {\n  const fileHandle = await window.showSaveFilePicker({\n    suggestedName: `WebAV-export-${Date.now()}.${extName}`,\n  });\n  return fileHandle.createWritable();\n}\n"}}]);